---
title: gchromVAR analysis of SuSiE and mvSuSiE fine-mapping results for UK Biobank blood cell traits
author: Peter Carbonetto
date: October 25, 2023
output:
  html_document:
    theme: readable
    lib_dir: site_libs
    self_contained: no
---

TO DO: Add summary of the [gchromvar][gchromvar] analysis here.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(BuenColors)
library(ggplot2)
library(ggrepel)
library(cowplot)
```

For reproducibility, set the seed.

```{r set-seed}
set.seed(1)
```

These are the cell types in the hematopoesis hierarchy:

```{r celltypes}
celltypes <- c("B","CD4","CD8","CLP","CMP","Ery","GMP-A","GMP-B","GMP-C",
               "HSC","LMPP","mDC","Mega","MEP","mono","MPP","NK","pDC")
celltype_colors <- c(jdb_color_map(celltypes[1:11]),
                     c("yellow","hotpink"),
                     jdb_color_map(celltypes[14:18]))
names(celltype_colors) <- celltypes
```

Load the SuSiE and mvSuSiE gchomeVAR results:

```{r read-susie-results}
susie   <- read.csv("../output/blood_cell_traits/gchromvar_susie.csv",
                    stringsAsFactors = FALSE)
mvsusie <- read.csv("../output/blood_cell_traits/gchromvar_mvsusie.csv",
                    stringsAsFactors = FALSE)
susie   <- transform(susie,
                     celltype = factor(celltype,celltypes),
					 trait    = factor(trait))
mvsusie <- transform(mvsusie,
                     celltype = factor(celltype,celltypes),
					 trait    = factor(trait))
```

For a point of comparison, we will use the gchromVAR results from the
[Vuckovic *et al* paper][vuckovic-cell] (they were downloaded from
[here][vuckovic-github]):

```{r read-vuckovic-results}
vuckovic_traits <- c("rbc","mcv","hct","hgb","hlr","irf","mch","mchc","mrv",
                     "mscv","rdw_cv","ret","plt","mpv","pct","pdw","wbc",
					 "baso","eo","mono","neut","lymph")
vuckovic <- read.table("../data/vuckovic_gchromVAR_zscores_ukbb_v2.txt",
                       sep = "\t",header = TRUE,stringsAsFactors = FALSE)
vuckovic <- transform(vuckovic,
                      Celltype = factor(Celltype,celltypes),
					  Trait = factor(Trait,vuckovic_traits))
```

ADD TEXT HERE.

```{r mvsusie-vs-susie, fig.height=7, fig.width=8, warning=FALSE}
p        <- vector("list",length(celltypes))
names(p) <- celltypes
for (i in celltypes) {
  dat1 <- subset(susie,celltype == i)
  dat2 <- subset(mvsusie,celltype == i)
  pdat <- data.frame(trait   = as.character(dat1$trait),
                     susie   = dat1$pval,
                     mvsusie = dat2$pval,
					 stringsAsFactors = FALSE)
  p[[i]] <- ggplot(pdat,aes(x = susie,y = mvsusie,label = trait)) +
    geom_point(shape = 20,color = celltype_colors[i]) +
	geom_abline(intercept = 0,slope = 1,color = "black",linetype = "dotted") +
    geom_text_repel(size = 2,segment.color = "darkgray",segment.size = 0.25,
                    min.segment.length = 0) +
    xlim(0,max(pdat[,2:3])) +
	ylim(0,max(pdat[,2:3])) +
	ggtitle(i) +
    theme_cowplot(font_size = 9) +
	theme(plot.title = element_text(size = 10,face = "plain"))
}
do.call(plot_grid,p)
```

ADD TEXT HERE.

```{r heatmap-susie, fig.height=3, fig.width=4, eval=FALSE}
n <- nrow(z_susie)
threshold <- (-log10(0.05/n))
pdat <- transform(z_susie,pval = pmin(pval,10))
ggplot(pdat,aes(x = celltype,y = trait,fill = celltype,size = pval)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(2,6),limits = c(threshold,10)) + 
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5),
        panel.grid = element_line(color = "lightgray",size = 0.3,
                                  linetype = "dotted"))
```

This plot reproduces Fig. 3A from the Vuckovic *et al* paper:

```{r heatmap-vuckovic, fig.height=3, fig.width=4, eval=FALSE}
pdat <- transform(vuckovic,pval = pmin(pval,10))
ggplot(vuckovic,aes(x = Celltype,y = Trait,fill = Celltype,size = pval)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(0.65,6)) +
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))
```

ADD TEXT HERE

```{r, eval=FALSE}
plot(subset(vuckovic,Trait == "wbc")$zscore,
     subset(z_susie,trait == "WBC_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "plt")$zscore,
     subset(z_susie,trait == "Platelet_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "rbc")$zscore,
     subset(z_susie,trait == "RBC_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "hgb")$zscore,
     subset(z_susie,trait == "Haemoglobin")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "mcv")$zscore,
     subset(z_susie,trait == "MCV")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "pct")$zscore,
     subset(z_susie,trait == "Plateletcrit")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
```

This last code chunk is a record of the exact versions of the R
packages used to generate the results (in case we want to reproduce
this analysis):

```{r session-info}
sessionInfo()
```

[gchromvar]: https://github.com/caleblareau/gchromVAR
[vuckovic-cell]: https://doi.org/10.1016/j.cell.2020.08.008
[vuckovic-github]: https://github.com/bloodcellgwas/manuscript_code

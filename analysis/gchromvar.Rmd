---
title: gchromVAR analysis of SuSiE and mvSuSiE fine-mapping results for UK Biobank blood cell traits
author: Peter Carbonetto
date: October 23, 2023
output:
  html_document:
    theme: readable
    highlight: textmate
    lib_dir: site_libs
    self_contained: no
---

TO DO: Add summary of the [gchromvar][gchromvar] analysis here.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(chromVAR)
library(gchromVAR)
library(BuenColors)
library(SummarizedExperiment)
library(data.table)
library(BiocParallel)
library(BSgenome.Hsapiens.UCSC.hg19)
library(ggplot2)
library(cowplot)
library(reshape2)
```

For reproducibility, set the seed.

```{r set-seed}
set.seed(1)
```

Load the susie_rss blood cell trait fine-mapping results. Here we will
limit to results with PIP > 0.01.

```{r read-mvsusie-results}
susie_outfile   <- file.path("../output/blood_cell_traits",
                             "susierss.notrem.CS_purity0.5.summary.csv.gz")
susie <- read.csv(susie_outfile,header = TRUE,stringsAsFactors = FALSE)
susie <- transform(susie,
                   CHR    = factor(CHR,1:22),
                   Region = factor(Region),
				   trait  = factor(trait),
                   REF    = factor(REF),
                   ALT    = factor(ALT))
susie <- subset(susie,PIP > 0.01)
```

Build a set of consensus, equal-width peaks spanning the hematopoesis
phenotypes.

```{r create-ranged-summarized-experiment, message=FALSE}
counts_file <- paste0(system.file("extdata/paper",package = "gchromVAR"),
                      "/hemeCounts.tsv.gz")
peaks_file <- paste0(system.file("extdata/paper",package = "gchromVAR"),
                     "/hemePeaks.bed.gz")
peaksdf <- data.frame(fread(paste0("zcat < ",peaks_file)))
peaks <- makeGRangesFromDataFrame(peaksdf,
                                  seqnames = "V1",
                                  start.field = "V2",
                                  end.field = "V3")
counts <- data.matrix(fread(paste0("zcat < ", counts_file)))
hema_dat <- SummarizedExperiment(assays = list(counts = counts),
                                 rowData = peaks, 
                                 colData = DataFrame(names = colnames(counts)))
hema_dat <- addGCBias(hema_dat,genome = BSgenome.Hsapiens.UCSC.hg19)
```

Encode the fine-mapping results for each trait as a BED file.

```{r write-bed}
traits <- levels(susie$trait)
bed_files <- paste(traits,"bed",sep = ".")
for (i in traits) {
  dat  <- subset(susie,trait == i)
  dat  <- dat[c("CHR","POS","Region","PIP")]
  names(dat) <- c("chr","start","region","pip")
  rows <- order(dat$chr,dat$start)
  dat  <- dat[rows,]
  dat <- transform(dat,
                   chr = paste0("chr",chr),
                   end = start + 1)
  dat <- dat[c("chr","start","end","region","pip")]
  dat$pip <- format(dat$pip,digits = 4) 
  write.table(dat,paste(i,"bed",sep = "."),quote = FALSE,sep = "\t",
              row.names = FALSE,col.names = FALSE)
}
```

Now we are ready to compute the weighted deviations using gchromVAR.

```{r wdev-susie}
susie_se <- importBedScore(rowRanges(hema_dat),bed_files,colidx = 5)
wdev_susie <- computeWeightedDeviations(hema_dat,susie_se)
```

Extract the z-scores and compute p-values.

```{r pval-susie}
z_susie <- assays(wdev_susie)$z
names(dimnames(z_susie)) <- c("trait","celltype")
z_susie <- melt(z_susie)
names(z_susie) <- c("trait","celltype","zscore")
```

Perform the lineage-specific enrichment tests:

```{r enrichment-tests-susie}
Ery   <- c("HSC","MPP","CMP","MEP","Ery")
Meg   <- c("HSC","MPP","CMP","MEP","Mega")
Mye   <- c("HSC","MPP","CMP","LMPP","GMP-A","GMP-B","GMP-C","Mono","mDC")
Lymph <- c("HSC","MPP","LMPP","CLP","NK","pDC","CD4","CD8","B")
z_susie$enrich  <-
    (z_susie$trait == "Basophill_perc"    & z_susie$celltype %in% Mye) +
    (z_susie$trait == "Eosinophill_perc"  & z_susie$celltype %in% Mye) + 
    (z_susie$trait == "Neutrophill_perc"  & z_susie$celltype %in% Mye) +
    (z_susie$trait == "Monocyte_perc"     & z_susie$celltype %in% Mye) +
    (z_susie$trait == "WBC_count"      & z_susie$celltype %in% c(Mye,Lymph)) + 
    (z_susie$trait == "Lymphocyte_perc"   & z_susie$celltype %in% Lymph) +
    (z_susie$trait == "Platelet_count"    & z_susie$celltype %in% Meg) + 
    (z_susie$trait == "PDW"               & z_susie$celltype %in% Meg) + 
    (z_susie$trait == "Plateletcrit"      & z_susie$celltype %in% Meg) +
    (z_susie$trait == "Haemoglobin"       & z_susie$celltype %in% Ery) +
    (z_susie$trait == "RDW"               & z_susie$celltype %in% Ery) +
    (z_susie$trait == "MCV"               & z_susie$celltype %in% Ery) +
    (z_susie$trait == "RBC_count"         & z_susie$celltype %in% Ery) +
    (z_susie$trait == "Reticulocyte_perc" & z_susie$celltype %in% Ery) +
    (z_susie$trait == "HLR_perc"          & z_susie$celltype %in% Ery)
z_susie$pval <- -log10(pnorm(z_susie$zscore,lower.tail = FALSE))
```

ADD TEXT HERE.

```{r heatmap-susie, fig.height=3, fig.width=4}
n <- nrow(z_susie)
threshold <- (-log10(0.05/n))
celltypes <- c("B","CD4","CD8","CLP","CMP","Ery","GMP-A","GMP-B","GMP-C",
               "HSC","LMPP","mDC","Mega","MEP","mono","MPP","NK","pDC")
celltype_colors <- c(jdb_color_map(celltypes[1:11]),
                     c("yellow","hotpink"),
                     jdb_color_map(celltypes[14:18]))
heatmap_colors <- c("#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6")
pdat <- transform(z_susie,
                  pval = pmin(pval,10))
ggplot(pdat,aes(x = celltype,y = trait,fill = celltype,size = pval)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(1,5),limits = c(threshold,10)) + 
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))
```

For a point of comparison, we will use the gchromVAR results from the
[Vuckovic *et al* paper][vuckovic-cell] (they were downloaded from
[here][vuckovic-github]):

```{r read-vuckovic-results}
vuckovic_traits <- c("rbc","mcv","hct","hgb","hlr","irf","mch","mchc","mrv",
                     "mscv","rdw_cv","ret","plt","mpv","pct","pdw","wbc",
					 "baso","eo","mono","neut","lymph")
vuckovic <- read.table("../data/vuckovic_gchromVAR_zscores_ukbb_v2.txt",
                       sep = "\t",header = TRUE,stringsAsFactors = FALSE)
vuckovic <- transform(vuckovic,
                      Celltype = factor(Celltype,celltypes),
					  Trait = factor(Trait,vuckovic_traits),
					  pval = pmin(pval,10))
```

This plot reproduces Fig. 3A from the Vuckovic *et al* paper:

```{r heatmap-vuckovic, fig.height=3, fig.width=4}
pdat <- transform(vuckovic,pval = pmin(pval,10))
ggplot(vuckovic,aes(x = Celltype,y = Trait,fill = Celltype,size = pval)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(0.65,6)) +
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))
```

ADD TEXT HERE

```{r}
plot(subset(vuckovic,Trait == "wbc")$zscore,
     subset(z_susie,trait == "WBC_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "plt")$zscore,
     subset(z_susie,trait == "Platelet_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "rbc")$zscore,
     subset(z_susie,trait == "RBC_count")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "hgb")$zscore,
     subset(z_susie,trait == "Haemoglobin")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "mcv")$zscore,
     subset(z_susie,trait == "MCV")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
plot(subset(vuckovic,Trait == "pct")$zscore,
     subset(z_susie,trait == "Plateletcrit")$zscore,
	 pch = 20,xlab = "vuckovic et al",ylab = "susie")
abline(a = 0,b = 1,lty = "dashed",col = "deepskyblue")	 
```

This last code chunk is a record of the exact versions of the R
packages used to generate the results (in case we want to reproduce
this analysis):

```{r session-info}
sessionInfo()
```

[gchromvar]: https://github.com/caleblareau/gchromVAR
[vuckovic-cell]: https://doi.org/10.1016/j.cell.2020.08.008
[vuckovic-github]: https://github.com/bloodcellgwas/manuscript_code

---
title: gchromVAR analysis of SuSiE and mvSuSiE fine-mapping results for UK Biobank blood cell traits
author: Peter Carbonetto
date: October 25, 2023
output:
  html_document:
    theme: readable
    lib_dir: site_libs
    self_contained: no
---

Here we summarize the results of a [gchromVAR][gchromvar] analysis
using the susie and mvsusie fine-mapping results for the blood cell
traits. We compare against the gchromVAR analysis that was done in the
[Vuckovic *et al* paper][vuckovic-cell].

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(ashr)
library(BuenColors)
library(ggplot2)
library(ggrepel)
library(cowplot)
```

For reproducibility, set the seed.

```{r set-seed}
set.seed(1)
```

These are the cell types in the hematopoesis hierarchy:

```{r celltypes}
celltypes <- c("B","CD4","CD8","CLP","CMP","Ery","GMP-A","GMP-B","GMP-C",
               "HSC","LMPP","mDC","Mega","MEP","mono","MPP","NK","pDC")
celltype_colors <- c(jdb_color_map(celltypes[1:11]),
                     c("yellow","hotpink"),
                     jdb_color_map(celltypes[14:18]))
names(celltype_colors) <- celltypes
```

Load the SuSiE and mvSuSiE gchomeVAR results:

```{r read-susie-results}
susie_traits <- rev(
  c("Lymphocyte_perc","Neutrophill_perc","Monocyte_perc","Eosinophill_perc",
    "Basophill_perc","WBC_count","PDW","Platelet_count","Plateletcrit",
	"Reticulocyte_perc","RDW","MSCV","HLR_perc","Haemoglobin","MCV",
	"RBC_count"))
susie <- read.csv("../output/blood_cell_traits/gchromvar/gchromvar_susie.csv",
                  stringsAsFactors = FALSE)
mvsusie <- read.csv("../output/blood_cell_traits/gchromvar/gchromvar_mvsusie.csv",
                    stringsAsFactors = FALSE)
susie   <- transform(susie,
                     celltype = factor(celltype,celltypes),
					 trait    = factor(trait,susie_traits))
mvsusie <- transform(mvsusie,
                     celltype = factor(celltype,celltypes),
					 trait    = factor(trait,susie_traits))
```

For a point of comparison, we will use the gchromVAR results from the
[Vuckovic *et al* paper][vuckovic-cell] (they were downloaded from
[here][vuckovic-github]):

```{r read-vuckovic-results}
vuckovic_traits <- c("rbc","mcv","hct","hgb","hlr","irf","mch","mchc","mrv",
                     "mscv","rdw_cv","ret","plt","mpv","pct","pdw","wbc",
					 "baso","eo","mono","neut","lymph")
vuckovic <- read.table("../data/vuckovic_gchromVAR_zscores_ukbb_v2.txt",
                       sep = "\t",header = TRUE,stringsAsFactors = FALSE)
vuckovic <- transform(vuckovic,
                      Celltype = factor(Celltype,celltypes),
					  Trait = factor(Trait,vuckovic_traits))
```

Shrink the *z*-scores using adaptive shrinkage:

```{r ashr-vuckovic}
ash1 <- ash(susie$zscore,1)
ash2 <- ash(mvsusie$zscore,1)
ash3 <- ash(vuckovic$zscore,1)
susie    <- transform(susie,
                      zscore = with(ash1$result,PosteriorMean/PosteriorSD),
                      lfsr = -log10(ash1$result$lfsr))
mvsusie  <- transform(mvsusie,
                      zscore = with(ash2$result,PosteriorMean/PosteriorSD),
                      lfsr = -log10(ash2$result$lfsr))
vuckovic <- transform(vuckovic,
                      zscore = with(ash3$result,PosteriorMean/PosteriorSD),
                      lfsr = -log10(ash3$result$lfsr))
```

This plot roughly reproduces Fig. 3A from the Vuckovic *et al* paper:

```{r heatmap-vuckovic, fig.height=3, fig.width=3.75, warning=FALSE}
pdat <- transform(vuckovic,lfsr = pmin(lfsr,10))
p1<-ggplot(vuckovic,aes(x = Celltype,y = Trait,fill = Celltype,size = lfsr)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(1,7),limits = c(2,10)) +
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))
p1
```

Let's now compare these results to the results generated by the
mvsusie fine-mapping of blood cell traits:

```{r heatmap-mvsusie, fig.height=3.25, fig.width=7, warning=FALSE}
pdat <- transform(mvsusie,lfsr = pmin(lfsr,10))
p2 <- ggplot(mvsusie,aes(x = celltype,y = trait,fill = celltype,size = lfsr)) +
  geom_point(shape = 21,color = "white") +
  scale_size(range = c(1,7),limits = c(2,10)) +
  scale_fill_manual(values = celltype_colors,guide = "none") +
  guides(size = guide_legend(override.aes = list(shape = 21,fill = "black"))) +
  theme_cowplot(font_size = 9) +
  labs(x = "",y = "") +
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))
plot_grid(p1 + ggtitle("vuckovic et al"),
          p2 + ggtitle("mvsusie"),
		  rel_widths = c(87,100))
```

Compare the susie-based and mvsusie-based gchromVAR *z*-scores:

```{r mvsusie-vs-susie, fig.height=3.25, fig.width=4, warning=FALSE}
pdat <- data.frame(trait    = susie$trait,
                   celltype = susie$celltype,
				   susie    = susie$zscore,
                   mvsusie  = mvsusie$zscore)
z <- c(susie$zscore,mvsusie$zscore)
ggplot(pdat,aes(x = susie,y = mvsusie,color = celltype,label = trait)) +
  geom_point(shape = 20,size = 1.75) +
  geom_abline(intercept = 0,slope = 1,color = "black",linetype = "dotted") +
  geom_text_repel(size = 2,segment.color = "darkgray",segment.size = 0.25,
                  min.segment.length = 0) +
  scale_color_manual(values = celltype_colors) +
  xlim(min(z),max(z)) +
  ylim(min(z),max(z)) +
  theme_cowplot(font_size = 10)
```

The same comparison, broken down by cell type:

```{r mvsusie-vs-susie-2, fig.height=7, fig.width=8, warning=FALSE}
p        <- vector("list",length(celltypes))
names(p) <- celltypes
for (i in celltypes) {
  dat1 <- subset(susie,celltype == i)
  dat2 <- subset(mvsusie,celltype == i)
  z    <- c(dat1$z,dat2$z)
  pdat <- data.frame(trait   = as.character(dat1$trait),
                     susie   = dat1$zscore,
                     mvsusie = dat2$zscore,
					 stringsAsFactors = FALSE)
  p[[i]] <- ggplot(pdat,aes(x = susie,y = mvsusie,label = trait)) +
    geom_point(shape = 20,color = celltype_colors[i]) +
	geom_abline(intercept = 0,slope = 1,color = "black",linetype = "dotted") +
    xlim(min(z),max(z)) +
	ylim(min(z),max(z)) +
	ggtitle(i) +
    theme_cowplot(font_size = 9) +
	theme(plot.title = element_text(size = 10,face = "plain"))
}
do.call(plot_grid,p)
```

Validation of the mvsusie-based gchromVAR analysis by comparing the
*z*-scores for the 6 traits that were common to the mvsusie-based
analysis and the Vuckovic *et al* analysis:

```{r mvsusie-vs-vuckovic, fig.width=6, fig.height=4}
create_scatterplot <- function (z1, z2, title) {
  pdat <- data.frame(z1 = z1,z2 = z2)
  z    <- c(z1,z2)
  return(ggplot(pdat,aes(x = z1,y = z2)) +
    geom_point(shape = 20) +
	geom_abline(intercept = 0,slope = 1,color = "magenta",
	            linetype = "dotted") +
	xlim(min(z),max(z)) +
	ylim(min(z),max(z)) +
	labs(x = "vuckovic et al",y = "mvsusie",title = title) +
	theme_cowplot(font_size = 9) +
	theme(plot.title = element_text(size = 9,face = "plain")))
}
p1 <- create_scatterplot(subset(vuckovic,Trait == "wbc")$zscore,
                         subset(mvsusie,trait == "WBC_count")$zscore,
						 "WBC count")
p2 <- create_scatterplot(subset(vuckovic,Trait == "plt")$zscore,
                         subset(mvsusie,trait == "Platelet_count")$zscore,
						 "platelet count")
p3 <- create_scatterplot(subset(vuckovic,Trait == "rbc")$zscore,
                         subset(mvsusie,trait == "RBC_count")$zscore,
						 "RBC count")
p4 <- create_scatterplot(subset(vuckovic,Trait == "hgb")$zscore,
                         subset(mvsusie,trait == "Haemoglobin")$zscore,
						 "Haemoglobin")
p5 <- create_scatterplot(subset(vuckovic,Trait == "mcv")$zscore,
                         subset(mvsusie,trait == "MCV")$zscore,
						 "MCV")
p6 <- create_scatterplot(subset(vuckovic,Trait == "pct")$zscore,
                         subset(mvsusie,trait == "Plateletcrit")$zscore,
						 "Platelet crit.")
plot_grid(p1,p2,p3,p4,p5,p6,nrow = 2,ncol = 3)
```

This last code chunk is a record of the exact versions of the R
packages used to generate the results (in case we want to reproduce
this analysis):

```{r session-info}
sessionInfo()
```

[gchromvar]: https://github.com/caleblareau/gchromVAR
[vuckovic-cell]: https://doi.org/10.1016/j.cell.2020.08.008
[vuckovic-github]: https://github.com/bloodcellgwas/manuscript_code

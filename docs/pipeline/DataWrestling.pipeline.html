
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta charset='utf-8'>
 <title>DataWrestling.sos</title>
<meta http-equiv="content-type" content="text/html; charset=None">

<style type="text/css">
html {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}

body {
  margin: 0;
}

a {
  background-color: transparent;
  -webkit-text-decoration-skip: objects;
}

a:active,
a:hover {
  outline-width: 0;
}

img {
  border-style: none;
}

pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

button::-moz-focus-inner,
[type="button"]::-moz-focus-inner,
[type="reset"]::-moz-focus-inner,
[type="submit"]::-moz-focus-inner {
  border-style: none;
  padding: 0;
}

button:-moz-focusring,
[type="button"]:-moz-focusring,
[type="reset"]:-moz-focusring,
[type="submit"]:-moz-focusring {
  outline: 1px dotted ButtonText;
}

table {
  border-spacing: 0;
  border-collapse: collapse;
}

td {
  padding: 0;
}

* {
  box-sizing: border-box;
}

body {
  font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  color: #333;
  background-color: #fff;
}

a {
  color: #4078c0;
  text-decoration: none;
}

a:hover,
a:active {
  text-decoration: underline;
}

pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.container {
  width: 980px;
  margin-right: auto;
  margin-left: auto;
}

.container::before {
  display: table;
  content: "";
}

.container::after {
  display: table;
  clear: both;
  content: "";
}

.right {
  float: right !important;
}

::-moz-placeholder {
  color: #999;
}

:-ms-input-placeholder {
  color: #999;
}

::placeholder {
  color: #999;
}

.form-select::-ms-expand {
  opacity: 0;
}

.avatar {
  display: inline-block;
  overflow: hidden;
  line-height: 1;
  vertical-align: middle;
  border-radius: 3px;
}

.commit-tease {
  position: relative;
  padding: 10px;
  margin-bottom: -1px;
  line-height: 20px;
  color: #68777d;
  background-color: #f2f9fc;
  border: 1px solid #c9e6f2;
  border-radius: 3px;
  border-bottom-right-radius: 0;
  border-bottom-left-radius: 0;
}

.commit-tease .message {
  color: inherit;
}

.commit-tease .avatar {
  margin-top: -1px;
}

.commit-tease-sha {
  display: inline-block;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  color: #445055;
}

.full-commit .btn-outline:not(:disabled):hover {
  color: #4078c0;
  border: 1px solid #4078c0;
}

.blob-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  border-bottom-right-radius: 3px;
  border-bottom-left-radius: 3px;
}

.blob-num {
  width: 1%;
  min-width: 50px;
  padding-right: 10px;
  padding-left: 10px;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
  line-height: 18px;
  color: rgba(0,0,0,0.3);
  text-align: right;
  white-space: nowrap;
  vertical-align: bottom;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  border: solid #eee;
  border-width: 0 1px 0 0;
}

.blob-num:hover {
  color: rgba(0,0,0,0.6);
}

.blob-num::before {
  content: attr(data-line-number);
}

.blob-code {
  position: relative;
  padding-right: 10px;
  padding-left: 10px;
  vertical-align: top;
  white-space: nowrap;
}

.sos-comment {
  /* background: #f7f7f7; */
}
.sos-report {
  background: #FAFAD2;
  padding-top: 5px;
}
.sos-header {
  margin-top: 5px;
  margin-bottom: 0px;
  padding-top: 5px;
  padding-bottom: 5px;
  background-color: #ddd;
  /* border-bottom-color: #dde4e6; */
  color: darkblue;
  border-top-style: solid;

}
.sos-directive {
  padding-top: 5px;
  /* background-color: #fff9ea; */
  border-color: #f1c0c0;
}
.sos-statement {
  padding-top: 5px;
  /* background-color: #f2f9fc; */
}
.sos-error {
  /* background: #ffdddd; */
  color: red;
}
.sos-script {
  position: relative;
  padding-right: 10px;
  padding-left: 30px;
  vertical-align: top;
  /* background-color: #eff0f1; */
}


.blob-code-inner {
  overflow: visible;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
  color: #333;
  word-wrap: normal;
  white-space: pre;
}

.blob-code-inner::before {
  content: "";
}

body {
  min-width: 1020px;
  word-wrap: break-word;
}

.user-mention {
  font-weight: bold;
  color: #333;
  white-space: nowrap;
}

.prose-diff>.markdown-body :not(li.moved).removed {
  color: #a33;
  text-decoration: line-through;
  background: #ffeaea;
}

.prose-diff>.markdown-body :not(.github-user-ins):not(li.moved).removed {
  text-decoration: line-through;
}

.prose-diff>.markdown-body :not(li.moved).added {
  background: #eaffea;
}

.prose-diff>.markdown-body :not(.github-user-del):not(li.moved).added li:not(.moved):not(.github-user-del).added {
  text-decoration: none;
}

:checked+.radio-label {
  position: relative;
  z-index: 1;
  border-color: #4078c0;
}

.select-menu-text-filter input::-moz-placeholder {
  color: #aaa;
}

.select-menu-text-filter input:-ms-input-placeholder {
  color: #aaa;
}

.select-menu-text-filter input::placeholder {
  color: #aaa;
}

.tab-size[data-tab-size="8"] {
  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;
}

# override source
.source {
  background: auto;
}

.file {
  position: relative;
  margin-top: 20px;
  margin-bottom: 15px;
  border: 1px solid #ddd;
  border-radius: 3px;
}

.file-header {
  padding: 5px 10px;
  background-color: #f7f7f7;
  border-bottom: 1px solid #d8d8d8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

.file-header::before {
  display: table;
  content: "";
}

.file-header::after {
  display: table;
  clear: both;
  content: "";
}

.file-actions {
  float: right;
  padding-top: 3px;
}

.file-info {
  float: left;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
  line-height: 32px;
}

.file-info-divider {
  display: inline-block;
  width: 1px;
  height: 18px;
  margin-right: 3px;
  margin-left: 3px;
  vertical-align: middle;
  background-color: #ddd;
}

.header-search-input::-ms-clear {
  display: none;
}

.org-validate-group input::-ms-clear {
  display: none;
}


.source .c { color: #8f5902; font-style: italic } /* Comment */
.source .err { color: #a40000; border: 1px solid #ef2929 } /* Error */
.source .g { color: #000000 } /* Generic */
.source .k { color: #204a87; font-weight: bold } /* Keyword */
.source .l { color: #000000 } /* Literal */
.source .n { color: #000000 } /* Name */
.source .o { color: #ce5c00; font-weight: bold } /* Operator */
.source .x { color: #000000 } /* Other */
.source .p { color: #000000; font-weight: bold } /* Punctuation */
.source .ch { color: #8f5902; font-style: italic } /* Comment.Hashbang */
.source .cm { color: #8f5902; font-style: italic } /* Comment.Multiline */
.source .cp { color: #8f5902; font-style: italic } /* Comment.Preproc */
.source .cpf { color: #8f5902; font-style: italic } /* Comment.PreprocFile */
.source .c1 { color: #8f5902; font-style: italic } /* Comment.Single */
.source .cs { color: #8f5902; font-style: italic } /* Comment.Special */
.source .gd { color: #a40000 } /* Generic.Deleted */
.source .ge { color: #000000; font-style: italic } /* Generic.Emph */
.source .gr { color: #ef2929 } /* Generic.Error */
.source .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.source .gi { color: #00A000 } /* Generic.Inserted */
.source .go { color: #000000; font-style: italic } /* Generic.Output */
.source .gp { color: #8f5902 } /* Generic.Prompt */
.source .gs { color: #000000; font-weight: bold } /* Generic.Strong */
.source .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.source .gt { color: #a40000; font-weight: bold } /* Generic.Traceback */
.source .kc { color: #204a87; font-weight: bold } /* Keyword.Constant */
.source .kd { color: #204a87; font-weight: bold } /* Keyword.Declaration */
.source .kn { color: #204a87; font-weight: bold } /* Keyword.Namespace */
.source .kp { color: #204a87; font-weight: bold } /* Keyword.Pseudo */
.source .kr { color: #204a87; font-weight: bold } /* Keyword.Reserved */
.source .kt { color: #204a87; font-weight: bold } /* Keyword.Type */
.source .ld { color: #000000 } /* Literal.Date */
.source .m { color: #0000cf; font-weight: bold } /* Literal.Number */
.source .s { color: #4e9a06 } /* Literal.String */
.source .na { color: #c4a000 } /* Name.Attribute */
.source .nb { color: #204a87 } /* Name.Builtin */
.source .nc { color: #000000 } /* Name.Class */
.source .no { color: #000000 } /* Name.Constant */
.source .nd { color: #5c35cc; font-weight: bold } /* Name.Decorator */
.source .ni { color: #ce5c00 } /* Name.Entity */
.source .ne { color: #cc0000; font-weight: bold } /* Name.Exception */
.source .nf { color: #000000 } /* Name.Function */
.source .nl { color: #f57900 } /* Name.Label */
.source .nn { color: #000000 } /* Name.Namespace */
.source .nx { color: #000000 } /* Name.Other */
.source .py { color: #000000 } /* Name.Property */
.source .nt { color: #204a87; font-weight: bold } /* Name.Tag */
.source .nv { color: #000000 } /* Name.Variable */
.source .ow { color: #204a87; font-weight: bold } /* Operator.Word */
.source .w { color: #f8f8f8; text-decoration: underline } /* Text.Whitespace */
.source .mb { color: #0000cf; font-weight: bold } /* Literal.Number.Bin */
.source .mf { color: #0000cf; font-weight: bold } /* Literal.Number.Float */
.source .mh { color: #0000cf; font-weight: bold } /* Literal.Number.Hex */
.source .mi { color: #0000cf; font-weight: bold } /* Literal.Number.Integer */
.source .mo { color: #0000cf; font-weight: bold } /* Literal.Number.Oct */
.source .sa { color: #4e9a06 } /* Literal.String.Affix */
.source .sb { color: #4e9a06 } /* Literal.String.Backtick */
.source .sc { color: #4e9a06 } /* Literal.String.Char */
.source .dl { color: #4e9a06 } /* Literal.String.Delimiter */
.source .sd { color: #8f5902; font-style: italic } /* Literal.String.Doc */
.source .s2 { color: #4e9a06 } /* Literal.String.Double */
.source .se { color: #4e9a06 } /* Literal.String.Escape */
.source .sh { color: #4e9a06 } /* Literal.String.Heredoc */
.source .si { color: #4e9a06 } /* Literal.String.Interpol */
.source .sx { color: #4e9a06 } /* Literal.String.Other */
.source .sr { color: #4e9a06 } /* Literal.String.Regex */
.source .s1 { color: #4e9a06 } /* Literal.String.Single */
.source .ss { color: #4e9a06 } /* Literal.String.Symbol */
.source .bp { color: #3465a4 } /* Name.Builtin.Pseudo */
.source .fm { color: #000000 } /* Name.Function.Magic */
.source .vc { color: #000000 } /* Name.Variable.Class */
.source .vg { color: #000000 } /* Name.Variable.Global */
.source .vi { color: #000000 } /* Name.Variable.Instance */
.source .vm { color: #000000 } /* Name.Variable.Magic */
.source .il { color: #0000cf; font-weight: bold } /* Literal.Number.Integer.Long */
 </style>
</head>
<body>



<div class="container new-discussion-timeline experiment-repo-nav">

 <div class="commit-tease">
      <span class="right">
      </span>
 <div>
        <a class="header-logo-invertocat" href="https://vatlab.github.io/SOS" data-hotkey="g d" aria-label="Homepage">
        <img src="http://vatlab.github.io/SOS/img/sos_icon.svg" alt="sos_icon">
        </a>

        <span class="user-mention">DataWrestling.sos</span>
      </div>
      </div>

  <div class="repository-content">
  <div class="file">
  <div class="file-header">

  <div class="file-info">
      pipeline/DataWrestling.sos
      <span class="file-info-divider"></span>
    9.5 KiB
  </div>
  <div class="file-actions">
  </div>
  </div>
 <div itemprop="text" class="blob-wrapper data type-python">

<table class="highlight tab-size js-file-line-container"><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="ch">#!/usr/bin/env sos-runner</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>2</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># vim: set filetype=python: set expandtab : ts=4:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>3</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1">#fileformat=SOS1.0</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>4</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span> 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>5</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># This script provides routines for file conversions and data transformations</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>6</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span> 
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>7
8</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">project_name</span> <span class="o">=</span> <span class="s1">&#39;GTEx&#39;</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>9</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">vcf_by_chrom</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>10</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># split vcf by chroms</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>11
12
13
14
15</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">chrom</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="c1"># there is in fact no Y chrom</span>
<span class="kn">input:</span> <span class="kp">pattern</span> <span class="o">=</span> <span class="s2">&quot;{name}.vcf.gz&quot;</span><span class="p">,</span> <span class="kp">for_each</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chrom&#39;</span><span class="p">]</span>
<span class="kn">output:</span> <span class="n">expand_pattern</span><span class="p">(</span><span class="s2">&quot;${CONFIG[&#39;wd&#39;]}/${name!b}.chr{_chrom}.vcf.gz&quot;</span><span class="p">)</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>16</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>17
18</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>tabix <span class="si">${</span><span class="nv">input</span><span class="si">}</span> <span class="si">${</span><span class="nv">_chrom</span><span class="si">}</span> --print-header <span class="p">|</span> bgzip &gt; <span class="si">${</span><span class="nv">_output</span><span class="si">}</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>19</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">RNASeq_to_HDF5</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>20</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Convert RNASeq data to HDF5</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>21
22
23
24</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;np.uint32&#39;</span>
<span class="kn">output:</span> <span class="s2">&quot;${input[0]!nb}.hdf5&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>25</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fsample</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;First col of expression data is ENCODE gene name, 2nd col is HUGO name&#39;&#39;&#39;</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">skiprows</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
    <span class="n">dt</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">head</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">})</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                       <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fsample</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sample_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[[</span><span class="s1">&#39;SAMPID&#39;</span><span class="p">,</span> <span class="s1">&#39;SMTSD&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_dict</span><span class="p">:</span>
            <span class="n">sample_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sample_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[\W\d]+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
 
<span class="n">data</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">dtype</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">dtype</span><span class="p">})</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">sample</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">}</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">}):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">})</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">k</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>52</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">umich_to_plink_1</span><span class="p">,</span> <span class="n">broad_to_plink_1</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>53</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># VCF to plink format</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>54
55
56</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">input:</span> <span class="kp">group_by</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
<span class="kn">output:</span> <span class="s2">&quot;${_input!nn}.a2flipped.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>57</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>58
59</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>plink --vcf <span class="si">${</span><span class="nv">_input</span><span class="si">}</span> --out <span class="si">${</span><span class="nv">_output</span><span class="p">!n</span><span class="si">}</span> --make-bed
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>60</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">umich_to_plink_2</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>61</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Fix multi-allelic sites</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>62</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># By changing duplicate SNP ID</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>63
64
65</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">input:</span> <span class="kp">group_by</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
<span class="kn">output:</span> <span class="s2">&quot;${_input!n}.bim&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>66</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span> 
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
 
<span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;U48&#39;</span><span class="p">)</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">dup_list</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">deduped</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dup_list</span><span class="p">:</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">if</span> <span class="n">counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">else</span> <span class="n">name</span>
    <span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">deduped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="n">dat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deduped</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">dat</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>82</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">umich_to_plink_3</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>83</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># VCF to plink format</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>84
85
86</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">input:</span> <span class="kp">group_by</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
<span class="kn">output:</span> <span class="s2">&quot;${_input!nn}.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>87</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>88
89
90
91
92
93</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>paste &lt;<span class="o">(</span>cut -f2 <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span>.bim<span class="o">)</span> &lt;<span class="o">(</span>zcat <span class="si">${</span><span class="nv">_input</span><span class="p">!nn</span><span class="si">}</span>.vcf.gz <span class="p">|</span> grep -v <span class="s2">&quot;^#&quot;</span> <span class="p">|</span> cut -f4<span class="o">)</span> &gt; <span class="si">${</span><span class="nv">_input</span><span class="p">!nn</span><span class="si">}</span>.a2
plink --bfile <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span> <span class="se">\</span>
      --a2-allele <span class="si">${</span><span class="nv">_input</span><span class="p">!nn</span><span class="si">}</span>.a2 <span class="m">2</span> <span class="m">1</span> <span class="s1">&#39;#&#39;</span> <span class="se">\</span>
      --out <span class="si">${</span><span class="nv">_output</span><span class="p">!n</span><span class="si">}</span> --make-bed
rm -f <span class="si">${</span><span class="nv">_input</span><span class="p">!nn</span><span class="si">}</span>.a2
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>94</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">broad_to_plink_2</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>95</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Remove indel sites</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>96
97
98</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">input:</span> <span class="kp">group_by</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
<span class="kn">output:</span> <span class="s2">&quot;${_input!n}.snp_only.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>99</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>100
101
102
103
104</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>awk <span class="s1">&#39;{if ((length($5) &gt; 1 ) || (length($6) &gt; 1)) {print $2}}&#39;</span> <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span>.bim &gt; <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span>.exclude_id
plink --bfile <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span> --out <span class="si">${</span><span class="nv">_output</span><span class="p">!n</span><span class="si">}</span> --make-bed <span class="se">\</span>
      --exclude <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span>.exclude_id <span class="se">\</span>
rm -f <span class="si">${</span><span class="nv">_input</span><span class="p">!n</span><span class="si">}</span>.exclude_id
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>105</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">umich_to_plink_4</span><span class="p">,</span> <span class="n">broad_to_plink_3</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>106</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Merge all files</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>107
108</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">output:</span> <span class="s2">&quot;${workdir}/${project_name}.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>109</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>110
111
112
113</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="nb">echo</span> <span class="si">${</span><span class="nv">input</span><span class="p">!n</span><span class="si">}</span> <span class="p">|</span> sed <span class="s1">&#39;s/ /\n/g&#39;</span> <span class="p">|</span> grep -v chrX &gt; plink.merge-list
plink --bfile <span class="si">${</span><span class="nv">input</span><span class="p">[0]!n</span><span class="si">}</span> --merge-list plink.merge-list --out <span class="si">${</span><span class="nv">output</span><span class="p">!n</span><span class="si">}</span> --chr <span class="m">1</span>-22 --make-bed
rm plink.merge-list
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>114</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">variants_filter_1</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>115</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Exclude imputed variants</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>116
117
118</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">include</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">output:</span> <span class="s2">&quot;${input!n}.genotyped.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>119</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>120
121
122
123
124
125
126
127
128
129</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">imputed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;${input!n}.bim&quot;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">genotyped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;${include!n}.bim&quot;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">imputed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">imputed</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">imputed</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">genotyped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">genotyped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">genotyped</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">genotyped</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">imputed</span><span class="p">,</span> <span class="n">genotyped</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;${input!n}.extract_id&quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>130</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>131
132
133</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>plink --bfile <span class="si">${</span><span class="nv">input</span><span class="p">!n</span><span class="si">}</span> --out <span class="si">${</span><span class="nv">output</span><span class="p">!n</span><span class="si">}</span> --extract <span class="si">${</span><span class="nv">input</span><span class="p">!n</span><span class="si">}</span>.extract_id --make-bed
rm -f <span class="si">${</span><span class="nv">input</span><span class="p">!n</span><span class="si">}</span>.extract_id
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>134</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">variants_filter_2</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>135</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Filter by MAF, HWE etc</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>136
137
138
139</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">maf</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="kn">parameter:</span> <span class="n">mac</span> <span class="o">=</span> <span class="mi">10</span>
<span class="kn">output:</span> <span class="s2">&quot;${input!n}.filtered.bed&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="kp">workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>140</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">run:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>141
142</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span>plink --bfile <span class="si">${</span><span class="nv">input</span><span class="p">!n</span><span class="si">}</span> --maf <span class="si">${</span><span class="nv">maf</span><span class="si">}</span> --mac <span class="si">${</span><span class="nv">mac</span><span class="si">}</span> --make-bed --out <span class="si">${</span><span class="nv">output</span><span class="p">!n</span><span class="si">}</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>143</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">plink_to_hdf5_batch</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>144</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Convert plink genotype to HDF5 in batches of genes</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>145</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Only autosomal genes are considered</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>146</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># cis: ${cis} up/downstream from TSS of each gene</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>147
148
149
150
151
152
153</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">depends:</span> <span class="n">Py_Module</span><span class="p">(</span><span class="s2">&quot;pandas-plink&quot;</span><span class="p">)</span>
<span class="kn">parameter:</span> <span class="n">ann</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">cis</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="kn">parameter:</span> <span class="n">resume</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kn">output:</span> <span class="s2">&quot;${input!n}.cis.h5&quot;</span>
<span class="c1"># task: workdir = workdir</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>154</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pandas_plink</span> <span class="kn">import</span> <span class="n">read_plink</span>
 
<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">}):</span>
   <span class="k">if</span> <span class="err">$</span><span class="p">{</span><span class="n">resume</span><span class="p">}</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;loading existing database ${output!b}&quot;</span><span class="p">)</span>
      <span class="n">keys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{} existing genes will be skipped&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">})</span>
 
<span class="p">(</span><span class="n">bim</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">bed</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_plink</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="err">!</span><span class="n">nr</span><span class="p">})</span>
<span class="n">ann</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">ann</span><span class="err">!</span><span class="n">ar</span><span class="p">})</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
<span class="n">empty_genes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ann</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;[percent completed] </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">)])):</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="s1">&#39;/chr{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">snps</span> <span class="o">=</span> <span class="n">bim</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;chrom == &#39;{}&#39; and (pos &gt;= {} and pos &lt;= {})&quot;</span><span class="o">.</span>\
                            <span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="err">$</span><span class="p">{</span><span class="n">cis</span><span class="p">},</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="err">$</span><span class="p">{</span><span class="n">cis</span><span class="p">}))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">snps</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
        <span class="n">empty_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">continue</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">bed</span><span class="p">[</span><span class="n">snps</span><span class="o">.</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> 
                     <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">snps</span><span class="o">.</span><span class="n">snp</span><span class="p">,</span> <span class="n">snps</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="n">snps</span><span class="o">.</span><span class="n">a0</span><span class="p">)],</span> 
                     <span class="n">columns</span> <span class="o">=</span> <span class="n">fam</span><span class="o">.</span><span class="n">iid</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="s1">&#39;chr{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;${output!n}.empty_genes&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
     <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">empty_genes</span><span class="p">))</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>191</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">recode_platform</span><span class="p">:</span> <span class="kp">shared</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;platform_info&#39;</span><span class="p">:</span> <span class="s1">&#39;output&#39;</span><span class="p">}]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>192</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Covariate &quot;platform&quot; needs to be recoded</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>193
194
195</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">attr_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">input:</span> <span class="n">attr_file</span>
<span class="kn">output:</span> <span class="s2">&quot;${input}.platform_info&quot;</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>196</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>197
198
199
200
201
202
203
204
205
206
207
208
209</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;SUBJID&#39;</span><span class="p">,</span> <span class="s1">&#39;GENO_PLATFORM&#39;</span><span class="p">)]</span>
<span class="n">platform</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[[</span><span class="s1">&#39;SAMPID&#39;</span><span class="p">,</span> <span class="s1">&#39;SMGEBTCHT&#39;</span><span class="p">,</span> <span class="s1">&#39;SMAFRZE&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WGS&#39;</span><span class="p">:</span>
       <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">platform</span><span class="p">:</span>
          <span class="n">platform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]))</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>210</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">covariates_to_HDF5</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>211
212
213
214
215
216</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">peer_factors</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">pc_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">covar_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">output_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">input:</span> <span class="n">peer_factors</span><span class="p">,</span> <span class="n">pc_file</span><span class="p">,</span> <span class="n">covar_file</span><span class="p">,</span> <span class="n">platform_info</span>
<span class="kn">output:</span> <span class="n">output_file</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>217</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">ar</span><span class="p">}):</span>
   <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">ar</span><span class="p">})</span>
<span class="n">pc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">pc_file</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
     <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">,</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span><span class="s1">&#39;phen&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;PC{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])[[</span><span class="s2">&quot;PC1&quot;</span><span class="p">,</span> <span class="s2">&quot;PC2&quot;</span><span class="p">,</span> <span class="s2">&quot;PC3&quot;</span><span class="p">]]</span>
<span class="n">platform</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">platform_info</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">covar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">covar_file</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;SEX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">covar</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="c1"># Add PEER</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="err">$</span><span class="p">{</span><span class="n">peer_factors</span><span class="err">!</span><span class="n">ar</span><span class="p">,}]:</span>
    <span class="n">peer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">peer</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">samples</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">samples</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">samples</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">ar</span><span class="p">},</span> <span class="s1">&#39;/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">])),</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>239</pre></div></td><td class="code"><div class="source blob-code sos-header"><pre><span></span><span class="p">[</span><span class="n">subset_HDF5_data</span><span class="p">]</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>240</pre></div></td><td class="code"><div class="source blob-code sos-comment"><pre><span></span><span class="c1"># Given gene list, extract SNP and expression data from formatted database</span>
</pre></div>
</td></tr><tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>241
242
243
244
245
246
247
248</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">parameter:</span> <span class="n">ann_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">geno_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">expr_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">toy_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">parameter:</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">input:</span> <span class="s2">&quot;${geno_file!a}&quot;</span><span class="p">,</span> <span class="s2">&quot;${expr_file!a}&quot;</span>
<span class="kn">output:</span> <span class="s2">&quot;${toy_file!a}.genotype.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;${toy_file!a}.expr.h5&quot;</span>
 
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>249</pre></div></td><td class="code"><div class="source blob-code sos-directive"><pre><span></span><span class="kn">python:</span>
</pre></div>
</td></tr>
<tr><td class="blob-num js-line-number"><div class="linenodiv"><pre>250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273</pre></div></td><td class="code"><div class="source blob-code sos-script "><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># load gene annotation</span>
<span class="n">ann</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">ann_file</span><span class="err">!</span><span class="n">ar</span><span class="p">},</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">],</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ann</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">],</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">])}</span>
<span class="c1"># load gene list</span>
<span class="n">genes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">gene_list</span><span class="err">!</span><span class="n">ar</span><span class="p">},</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># purge existing toy</span>
<span class="n">gfile</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">}</span>
<span class="n">efile</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">}</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">gfile</span><span class="p">):</span>
   <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gfile</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">efile</span><span class="p">):</span>
   <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">efile</span><span class="p">)</span>
<span class="c1"># build toy</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">:</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">chrom</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
    <span class="n">geno</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="s1">&#39;chr{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
    <span class="n">geno</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">gfile</span><span class="p">,</span> <span class="s1">&#39;chr{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
 
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">})</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genes</span><span class="p">]</span>
    <span class="n">expr</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">efile</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
</pre></div>
</td></tr>
</table>
</div>
</div>
</div>
</body></html>

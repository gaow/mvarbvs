
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="ipynb_website:version" content="0.9.4" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" type="text/css" href="../css/jt.css">

<link rel="stylesheet" type="text/css" href="../css/toc2.css">

<link href="../site_libs/jqueryui-1.11.4/jquery-ui.css">
<link rel="stylesheet" href="../site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>

<link rel="stylesheet"
      href="../site_libs/highlightjs/null.min.css"
      type="text/css" />

<script src="../site_libs/highlightjs/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>

<script src="../js/doc_toc.js"></script>
<script src="../js/docs.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
        },
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>
<script>
function filterDataFrame(id) {
    var input = document.getElementById("search_" + id);
    var filter = input.value.toUpperCase();
    var table = document.getElementById("dataframe_" + id);
    var tr = table.getElementsByTagName("tr");
    // Loop through all table rows, and hide those who don't match the search query
    for (var i = 1; i < tr.length; i++) {
        for (var j = 0; j < tr[i].cells.length; ++j) {
            var matched = false;
            if (tr[i].cells[j].innerHTML.toUpperCase().indexOf(filter) != -1) {
                tr[i].style.display = "";
                matched = true
                break;
            }
            if (!matched)
                tr[i].style.display = "none";
        }
    }
}
function sortDataFrame(id, n, dtype) {
    var table = document.getElementById("dataframe_" + id);
    var tb = table.tBodies[0]; // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
    var tr = Array.prototype.slice.call(tb.rows, 0); // put rows into array
    if (dtype === 'numeric') {
        var fn = function(a, b) { 
            return parseFloat(a.cells[n].textContent) <= parseFloat(b.cells[n].textContent) ? -1 : 1;
        }
    } else {
        var fn = function(a, b) {
            var c = a.cells[n].textContent.trim().localeCompare(b.cells[n].textContent.trim()); 
            return c > 0 ? 1 : (c < 0 ? -1 : 0) }
    }
    var isSorted = function(array, fn) {
        if (array.length < 2)
            return 1;
        var direction = fn(array[0], array[1]); 
        for (var i = 1; i < array.length - 1; ++i) {
            var d = fn(array[i], array[i+1]);
            if (d == 0)
                continue;
            else if (direction == 0)
                direction = d;
            else if (direction != d)
                return 0;
            }
        return direction;
    }
    var sorted = isSorted(tr, fn);
    if (sorted == 1 || sorted == -1) {
        // if sorted already, reverse it
        for(var i = tr.length - 1; i >= 0; --i)
            tb.appendChild(tr[i]); // append each row in order
    } else {
        tr = tr.sort(fn);
        for(var i = 0; i < tr.length; ++i)
            tb.appendChild(tr[i]); // append each row in order
    }
}
</script>

<script>
$( document ).ready(function(){
            var cfg={'threshold':3,     // depth of toc (number of levels)
             'number_sections': false,
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }
            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;
            // fire the main function with these parameters
            table_of_contents(cfg, st);
            var file=dscDict[$("h1:first").attr("id")];
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=dscArray;
            var docs_map=dscArrayMap;
            var pos=dscArray.indexOf(file);
            for (var a=pos;a>=0;a--){
                  $('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+file+'.html'+'"]').css("color","#126dce");
            for (var a=pos+1;a<docs.length;a++){
                  $(".toc #toc-level0").append('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>');
            }
            // $("#toc-header").hide(); // comment out because it prevents search bar from displaying
    });
</script>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');
  // mark it active
  menuAnchor.parent().addClass('active');
  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>
<div class="container-fluid main-container">
<!-- tabsets -->
<script src="../site_libs/navigation-1.1/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>



<title>m&m ash</title>

<style type = "text/css">
body {
  font-family: "Droid Sans";
  padding-top: 66px;
  padding-bottom: 40px;
}
</style>
</head>

<body>
<div tabindex="-1" id="notebook" class="border-box-sizing">
<div class="container" id="notebook-container">

<!-- code folding -->

<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">m&m ash</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
<li>
  <a href="../index.html">Overview</a>
</li>
        
<li>
  <a href="../details.html">Details</a>
</li>
        
<li>
  <a href="../analysis.html">Analysis</a>
</li>
        
<li>
  <a href="../prototype.html">Prototype</a>
</li>
        
<li>
  <a href="../dsc.html">Dsc</a>
</li>
        
<li>
  <a href="../writeup.html">Writeup</a>
</li>
        
      </ul>
        
<ul class="nav navbar-nav navbar-right">
<li>
   <a href="http://github.com/gaow/mvarbvs"> <span class="fa fa-github"></span> </a>
</li>
</ul>
        
      </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Finemapping-benchmark">Finemapping benchmark<a class="anchor-link" href="#Finemapping-benchmark">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Simulation of multivariate phenotypes due to multiple effects:</p>
<ul>
<li>Take genotype data</li>
<li>Generate from ASH and MASH mixtures</li>
<li>With emphasize to LD convoluted regions</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Methods evaluated:</p>
<ul>
<li>Variational methods:<ul>
<li>spike-slab, mixture normal, sum of single effects, m&amp;m</li>
</ul>
</li>
<li>Popular fine-mapping methods:<ul>
<li>DAP, FINEMAP, CAVIAR</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/gkichaev/PAINTOR_V3.0">PAINTOR</a> is not included because <a href="https://github.com/gkichaev/PAINTOR_V3.0/issues/11#issuecomment-303135031">FINEMAP is recommanded over PAINTOR when used without annotation</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">revisions</span> <span class="o">-</span><span class="n">n</span> <span class="mi">5</span> <span class="o">--</span><span class="n">source</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">

        <table class="revision_table">
        <tr>
        <th>Revision</th>
        <th>Author</th>
        <th>Date</th>
        <th>Message</th>
        <tr>
        <tr><td><a target="_blank" href="http://github.com/gaow/mvarbvs/blob/9dc22d01b5ab00b4b26262d328c628c8bc145dd8/dsc/finemapping.ipynb"><span class="revision_id">9dc22d0<span></a></td>
<td>Gao Wang</td>
<td>2018-05-31</td>
<td>Update revision history for benchmark</td></tr><tr><td><a target="_blank" href="http://github.com/gaow/mvarbvs/blob/d9e5ceb4f6c307f003a263ec75ecb85f9ae129c8/dsc/finemapping.ipynb"><span class="revision_id">d9e5ceb<span></a></td>
<td>Gao Wang</td>
<td>2018-05-30</td>
<td>Add one more for caviar</td></tr><tr><td><a target="_blank" href="http://github.com/gaow/mvarbvs/blob/6ac6528277a5547347078c2f5fefadf4445d8dce/dsc/finemapping.ipynb"><span class="revision_id">6ac6528<span></a></td>
<td>Gao Wang</td>
<td>2018-05-29</td>
<td>Add draft PIP comparison</td></tr><tr><td><a target="_blank" href="http://github.com/gaow/mvarbvs/blob/ff41e212aad4daf1acfa53addd3ea9e149d9e060/dsc/finemapping.ipynb"><span class="revision_id">ff41e21<span></a></td>
<td>Gao Wang</td>
<td>2018-05-24</td>
<td>Add benchmark results comment</td></tr><tr><td><a target="_blank" href="http://github.com/gaow/mvarbvs/blob/ee8200f26924fe306a723a9e15e4742006d58f88/dsc/finemapping.ipynb"><span class="revision_id">ee8200f<span></a></td>
<td>Gao Wang</td>
<td>2018-05-23</td>
<td>Include caviar to susie comparison</td></tr></table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="DSC-benchmarks">DSC benchmarks<a class="anchor-link" href="#DSC-benchmarks">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="zzz.dsc"><code>zzz.dsc</code><a class="anchor-link" href="#zzz.dsc">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span><span class="o">.</span><span class="n">dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">setup</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">simulate</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_susie</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">evaluate</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/zzz.dsc" target="_blank">modules/zzz.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="master.dsc"><code>master.dsc</code><a class="anchor-link" href="#master.dsc">&#182;</a></h3><p>Master DSC script. More of a show-off of what we have. Not to be fully executed any time soon.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1">#!/usr/bin/env dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span>

<span class="kn">DSC:</span>
  <span class="n">define</span><span class="p">:</span>
    <span class="n">get_data</span><span class="p">:</span> <span class="n">full_data</span><span class="p">,</span> <span class="n">lite_data</span><span class="p">,</span> <span class="n">liter_data</span><span class="p">,</span> <span class="n">two_effect</span>
    <span class="n">get_response</span><span class="p">:</span> <span class="n">base_sim</span><span class="p">,</span> <span class="n">original_Y</span>
    <span class="n">fit</span><span class="p">:</span> <span class="p">(</span><span class="n">init_mnm</span> <span class="o">*</span> <span class="n">fit_mnm</span> <span class="o">*</span> <span class="n">plot_sse</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">fit_susie</span> <span class="o">*</span> <span class="p">(</span><span class="n">plot_sse</span><span class="p">,</span> <span class="n">plot_susie</span><span class="p">)),</span> 
        <span class="p">(</span><span class="n">fit_varbvs</span> <span class="o">*</span> <span class="n">plot_sse</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">fit_finemap</span> <span class="o">*</span> <span class="n">plot_finemap</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">fit_dap</span> <span class="o">*</span> <span class="n">plot_dap</span><span class="p">),</span>
        <span class="p">(</span><span class="n">fit_caviar</span> <span class="o">*</span> <span class="n">plot_caviar</span><span class="p">)</span>
  <span class="n">run</span><span class="p">:</span> <span class="n">get_data</span> <span class="o">*</span> <span class="n">summarize_ld</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">fit</span>
  <span class="n">exec_path</span><span class="p">:</span> <span class="n">modules</span>
  <span class="k">global</span><span class="p">:</span>
    <span class="n">data_file</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">dap_g_data</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">dap</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="benchmark.dsc" target="_blank">benchmark.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="mnm.dsc"><code>mnm.dsc</code><a class="anchor-link" href="#mnm.dsc">&#182;</a></h3><p>For M&amp;M model development: M&amp;M and compare with <code>susieR</code> + <code>varbvs</code></p>
<ul>
<li><code>debug_mnm</code>: ELBO now works with <code>liter_data</code>, but not <code>lite_data</code>.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">mnm</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1">#!/usr/bin/env dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span>

<span class="kn">DSC:</span>
  <span class="n">define</span><span class="p">:</span>
      <span class="n">setup</span><span class="p">:</span> <span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">lite_data</span><span class="p">,</span> <span class="n">liter_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">summarize_ld</span>
      <span class="n">get_response</span><span class="p">:</span> <span class="n">base_sim</span><span class="p">,</span> <span class="n">original_Y</span>
  <span class="n">run</span><span class="p">:</span> 
    <span class="n">debug_mnm</span><span class="p">:</span> <span class="n">setup</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">init_mnm</span> <span class="o">*</span> <span class="n">fit_mnm_debug</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_mnm</span><span class="p">:</span> <span class="n">setup</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">init_mnm</span> <span class="o">*</span> <span class="n">fit_mnm</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_susie</span><span class="p">:</span> <span class="n">setup</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">fit_susie</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_varbvs</span><span class="p">:</span> <span class="n">setup</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">fit_varbvs</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_susie_uni</span><span class="p">:</span> <span class="n">dap_g_data</span> <span class="o">*</span> <span class="n">original_Y</span> <span class="o">*</span> <span class="n">fit_susie</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_varbvs_uni</span><span class="p">:</span> <span class="n">dap_g_data</span> <span class="o">*</span> <span class="n">original_Y</span> <span class="o">*</span> <span class="n">fit_varbvs</span> <span class="o">*</span> <span class="n">plot_sse</span>
  <span class="n">exec_path</span><span class="p">:</span> <span class="n">modules</span>
  <span class="k">global</span><span class="p">:</span>
    <span class="n">data_file</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">dap_g_data</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">dap</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="mnm.dsc" target="_blank">mnm.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="susie.dsc"><code>susie.dsc</code><a class="anchor-link" href="#susie.dsc">&#182;</a></h3><p>For SSE model development: compare with <code>DAP-g</code>, <code>FINEMAP</code>, <code>CAVIAR</code> and <code>varbvs</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">susie</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1">#!/usr/bin/env dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span>

<span class="kn">DSC:</span>
  <span class="n">define</span><span class="p">:</span>
      <span class="n">get_data</span><span class="p">:</span> <span class="n">liter_data</span> 
  <span class="n">run</span><span class="p">:</span> 
    <span class="n">run_susie</span><span class="p">:</span> <span class="n">get_data</span> <span class="o">*</span> <span class="n">summarize_ld</span> <span class="o">*</span> <span class="n">simple_lm</span> <span class="o">*</span> <span class="n">fit_susie</span> <span class="o">*</span> <span class="p">(</span><span class="n">plot_sse</span><span class="p">,</span> <span class="n">plot_susie</span><span class="p">)</span>
    <span class="n">run_varbvs</span><span class="p">:</span> <span class="n">get_data</span> <span class="o">*</span> <span class="n">summarize_ld</span> <span class="o">*</span> <span class="n">simple_lm</span> <span class="o">*</span> <span class="n">fit_varbvs</span> <span class="o">*</span> <span class="n">plot_sse</span>
    <span class="n">run_comparison</span><span class="p">:</span> <span class="n">get_data</span> <span class="o">*</span> <span class="n">summarize_ld</span> <span class="o">*</span> <span class="n">lm_less</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="p">((</span><span class="n">fit_susie</span><span class="p">,</span> <span class="n">fit_susie01</span><span class="p">)</span> <span class="o">*</span> <span class="n">plot_susie</span><span class="p">,</span> <span class="n">fit_dap</span> <span class="o">*</span> <span class="n">plot_dap</span><span class="p">,</span> <span class="n">fit_caviar</span> <span class="o">*</span> <span class="n">plot_caviar</span><span class="p">)</span>
  <span class="n">exec_path</span><span class="p">:</span> <span class="n">modules</span>
  <span class="k">global</span><span class="p">:</span>
    <span class="n">data_file</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">dap_g_data</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">dap</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="susie.dsc" target="_blank">susie.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For <code>SuSiE</code> itself:</p>

<pre><code>dsc susie.dsc --target run_susie</code></pre>
<p>To compare with other methods on limited scenarios:</p>

<pre><code>dsc susie.dsc --target run_comparison -o susie_comparison</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="FINEMAP.dsc"><code>FINEMAP.dsc</code><a class="anchor-link" href="#FINEMAP.dsc">&#182;</a></h3><p>A closer look into the FINEMAP program; and CAVIAR.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">FINEMAP</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1">#!/usr/bin/env dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span>

<span class="kn">DSC:</span>
  <span class="n">define</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">:</span> <span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">lite_data</span><span class="p">,</span> <span class="n">liter_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">summarize_ld</span>
    <span class="n">get_response</span><span class="p">:</span> <span class="n">base_sim</span><span class="p">,</span> <span class="n">original_Y</span>
  <span class="n">run</span><span class="p">:</span>
    <span class="n">run_finemap</span><span class="p">:</span> <span class="n">setup</span> <span class="o">*</span> <span class="n">get_response</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">fit_finemap</span> <span class="o">*</span> <span class="n">plot_finemap</span>
    <span class="n">run_finemap_uni</span><span class="p">:</span> <span class="n">dap_g_data</span> <span class="o">*</span> <span class="n">original_Y</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">fit_finemap</span> <span class="o">*</span> <span class="n">plot_finemap</span>
    <span class="n">run_caviar_uni</span><span class="p">:</span> <span class="n">dap_g_data</span> <span class="o">*</span> <span class="n">original_Y</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">fit_caviar</span> <span class="o">*</span> <span class="n">plot_caviar</span>
  <span class="n">exec_path</span><span class="p">:</span> <span class="n">modules</span>
  <span class="k">global</span><span class="p">:</span>
    <span class="n">data_file</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">dap_g_data</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">dap</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="FINEMAP.dsc" target="_blank">FINEMAP.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="DAP-g.dsc"><code>DAP-g.dsc</code><a class="anchor-link" href="#DAP-g.dsc">&#182;</a></h3><p>A closer look into the DAP-g program, mostly the same as <code>FINEMAP.dsc</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">DAP</span><span class="o">-</span><span class="n">g</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1">#!/usr/bin/env dsc</span>
<span class="o">%</span><span class="n">include</span> <span class="n">modules</span><span class="o">/</span><span class="n">zzz</span>

<span class="kn">DSC:</span>
  <span class="n">define</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">:</span> <span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">lite_data</span><span class="p">,</span> <span class="n">liter_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">summarize_ld</span>
    <span class="n">get_response</span><span class="p">:</span> <span class="n">base_sim</span><span class="p">,</span> <span class="n">original_Y</span>
  <span class="n">run</span><span class="p">:</span>
    <span class="n">run_dap_z_uni</span><span class="p">:</span> <span class="n">dap_g_data</span> <span class="o">*</span> <span class="n">original_Y</span> <span class="o">*</span> <span class="n">get_sumstats</span> <span class="o">*</span> <span class="n">fit_dap_z</span> <span class="o">*</span> <span class="n">plot_dap</span>
  <span class="n">exec_path</span><span class="p">:</span> <span class="n">modules</span>
  <span class="k">global</span><span class="p">:</span>
    <span class="n">data_file</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">dap_g_data</span><span class="p">:</span> <span class="o">../</span><span class="n">data</span><span class="o">/</span><span class="n">dap</span><span class="o">-</span><span class="n">manifest</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="DAP-g.dsc" target="_blank">DAP-g.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="DSC-modules">DSC modules<a class="anchor-link" href="#DSC-modules">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="setup.dsc"><code>setup.dsc</code><a class="anchor-link" href="#setup.dsc">&#182;</a></h3><p>Data generators. See <code>20171103_MNMASH_Data.ipynb</code> for GTEx multitissue data preparation, if more real data are needed.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">dsc</span>

<span class="c1"># Modules to provide data</span>
<span class="c1"># Real or simulated</span>

<span class="c1"># Module output</span>
<span class="c1"># =============</span>
<span class="c1"># $data: full data</span>
<span class="c1"># $sumstats: summary statistics</span>

<span class="kn">full_data:</span> <span class="n">sim_utils</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span><span class="n">readRDS</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>
            <span class="n">data</span><span class="err">$</span><span class="n">X</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">[,</span><span class="n">get_center</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">))]);</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">cor</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">);</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">^</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sign</span><span class="p">(</span><span class="n">r2</span><span class="p">);</span>
            <span class="n">saveRDS</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">ld_mat</span><span class="p">);</span>
            <span class="n">write</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">ld_file</span><span class="p">,</span><span class="n">quote</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">))</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;full&quot;</span>
  <span class="n">dataset</span><span class="p">:</span> <span class="n">Shell</span><span class="p">{</span><span class="n">head</span> <span class="o">-</span><span class="mi">50</span> <span class="err">$</span><span class="p">{</span><span class="n">data_file</span><span class="p">}}</span>
  <span class="n">subset</span><span class="p">:</span> <span class="n">NULL</span>
  <span class="err">$</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span>
  <span class="err">$</span><span class="n">top_idx</span><span class="p">:</span> <span class="n">NULL</span>
  <span class="err">$</span><span class="n">ld_file</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
  <span class="err">$</span><span class="n">ld_mat</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">rds</span><span class="p">)</span>
        
<span class="n">lite_data</span><span class="p">(</span><span class="n">full_data</span><span class="p">):</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;2k&quot;</span>
  <span class="n">subset</span><span class="p">:</span> <span class="mi">2000</span>
             
<span class="n">liter_data</span><span class="p">(</span><span class="n">full_data</span><span class="p">):</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;1k&quot;</span>
  <span class="n">subset</span><span class="p">:</span> <span class="mi">1000</span>
            
<span class="n">two_effect</span><span class="p">(</span><span class="n">full_data</span><span class="p">):</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;two&quot;</span>
  <span class="n">subset</span><span class="p">:</span> <span class="mi">2</span>
             
<span class="n">dap_g_data</span><span class="p">(</span><span class="n">full_data</span><span class="p">):</span> <span class="n">R</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="err">$</span><span class="n">X</span><span class="p">;</span>
              <span class="n">r2</span> <span class="o">=</span> <span class="n">cor</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="n">r2</span> <span class="o">^</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sign</span><span class="p">(</span><span class="n">r2</span><span class="p">);</span>
              <span class="n">saveRDS</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">ld_mat</span><span class="p">);</span>
              <span class="n">write</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">ld_file</span><span class="p">,</span><span class="n">quote</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> \
              <span class="n">dap_g_paper</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span><span class="n">true_coef</span><span class="o">=</span><span class="n">B</span><span class="p">))</span>  
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;dap_g&quot;</span>
  <span class="n">dataset</span><span class="p">:</span> <span class="n">Shell</span><span class="p">{</span><span class="n">cat</span> <span class="err">$</span><span class="p">{</span><span class="n">dap_g_data</span><span class="p">}}</span>
             
<span class="kn">get_sumstats:</span> <span class="n">regression</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="n">mm_regression</span><span class="p">(</span><span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> 
                                                   <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">)))</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="n">abind</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="err">$</span><span class="n">sumstats</span><span class="p">:</span> <span class="n">res</span>
                                                   
<span class="kn">summarize_ld:</span> <span class="n">lib_regression_simulator</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
                <span class="n">regression_simulator</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
                <span class="n">Python</span><span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="n">summarize_LD</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">ld_mat</span><span class="p">,</span> <span class="n">ld_plot</span><span class="p">))</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">ld_mat</span><span class="p">:</span> <span class="err">$</span><span class="n">ld_mat</span>
  <span class="err">$</span><span class="n">ld_plot</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
  <span class="err">$</span><span class="n">top_idx</span><span class="p">:</span> <span class="n">res</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/setup.dsc" target="_blank">modules/setup.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="simulate.dsc"><code>simulate.dsc</code><a class="anchor-link" href="#simulate.dsc">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">simulate</span><span class="o">.</span><span class="n">dsc</span>

<span class="c1"># base_sim:</span>
<span class="c1"># - A base simulator of 2 independent multivariate effects</span>
<span class="c1"># - using MultivariateMixture</span>
<span class="c1"># original_Y：</span>
<span class="c1"># - do not simulate data, just use original</span>

<span class="kn">base_sim:</span> <span class="n">lib_regression_simulator</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
                <span class="n">regression_simulator</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
                <span class="n">Python</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">simulate_main</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;cache&#39;</span><span class="p">]))</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">python_modules</span> <span class="o">=</span> <span class="p">(</span><span class="n">seaborn</span><span class="p">,</span> <span class="n">matplotlib</span><span class="p">,</span> <span class="n">pprint</span><span class="p">)</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">top_idx</span><span class="p">:</span> <span class="err">$</span><span class="n">top_idx</span>
  <span class="n">n_signal</span><span class="p">:</span> <span class="mi">3</span>
  <span class="n">n_traits</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">eff_mode</span><span class="p">:</span> <span class="s2">&quot;mash_low_het&quot;</span>
  <span class="n">residual_mode</span><span class="p">:</span> <span class="s2">&quot;identity&quot;</span>
  <span class="n">swap_eff</span><span class="p">:</span> <span class="bp">True</span>
  <span class="n">keep_ld</span><span class="p">:</span> <span class="bp">True</span>
  <span class="n">center_data</span><span class="p">:</span> <span class="bp">True</span>
  <span class="n">cache</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;sim1&quot;</span>
  <span class="nd">@ALIAS</span><span class="p">:</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="err">!</span><span class="n">data</span><span class="p">,</span> <span class="err">!</span><span class="n">eff_mode</span><span class="p">)</span>
  <span class="err">$</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span>
  <span class="err">$</span><span class="n">V</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span>
  <span class="err">$</span><span class="n">N</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">simple_lm</span><span class="p">(</span><span class="n">base_sim</span><span class="p">):</span>
  <span class="n">eff_mode</span><span class="p">:</span> <span class="s2">&quot;simple_lm&quot;</span>
  <span class="n">amplitude</span><span class="p">:</span> <span class="mf">0.6</span>
  <span class="n">pve</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span>
  <span class="n">n_signal</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>

<span class="n">lm_less</span><span class="p">(</span><span class="n">simple_lm</span><span class="p">):</span>
  <span class="n">pve</span><span class="p">:</span> <span class="mf">0.2</span>

<span class="n">original_Y</span><span class="p">(</span><span class="n">base_sim</span><span class="p">):</span>
  <span class="n">eff_mode</span><span class="p">:</span> <span class="s2">&quot;original&quot;</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/simulate.dsc" target="_blank">modules/simulate.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit.dsc"><code>fit.dsc</code><a class="anchor-link" href="#fit.dsc">&#182;</a></h3><p>Fine mapping methods.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1"># workhorse(s) for finemapping</span>

<span class="c1"># Module input</span>
<span class="c1"># ============</span>
<span class="c1"># $data: full data; or</span>
<span class="c1"># $sumstats: summary statistics; or / and</span>
<span class="c1"># $ld: LD information</span>

<span class="c1"># Module output</span>
<span class="c1"># =============</span>
<span class="c1"># $fitted: for diagnostics</span>
<span class="c1"># $posterior: for inference</span>

<span class="kn">init_mnm:</span> <span class="n">init_mnm</span><span class="o">.</span><span class="n">R</span>
  <span class="c1"># mashr comes from `dev` branch on github</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="n">mashr</span>
  <span class="n">V</span><span class="p">:</span> <span class="err">$</span><span class="n">V</span>
  <span class="n">reg</span><span class="p">:</span> <span class="err">$</span><span class="n">sumstats</span>
  <span class="c1"># FIXME: these quantities are to be computed seperately and globally using mashr procedure</span>
  <span class="c1"># See http://stephenslab.github.io/gtex-eqtls/analysis/20171002_MASH_V8.html</span>
  <span class="n">Sigma</span><span class="p">:</span> <span class="s2">&quot;empirical&quot;</span>
  <span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.02</span><span class="p">),</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
  <span class="err">$</span><span class="n">model</span><span class="p">:</span> <span class="n">model</span>
  <span class="err">$</span><span class="n">V</span><span class="p">:</span> <span class="n">V</span>

<span class="kn">fit_mnm_debug:</span> <span class="n">regression</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">elbo_mnm</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">fit_mnm</span><span class="o">.</span><span class="n">R</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="n">mashr</span>
  <span class="n">maxL</span><span class="p">:</span> <span class="mi">5</span>
  <span class="n">maxI</span><span class="p">:</span> <span class="mi">20</span>
  <span class="n">get_elbo</span><span class="p">:</span> <span class="n">TRUE</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">model</span><span class="p">:</span> <span class="err">$</span><span class="n">model</span>
  <span class="n">V</span><span class="p">:</span> <span class="err">$</span><span class="n">V</span>
  <span class="err">$</span><span class="n">fitted</span><span class="p">:</span> <span class="n">fitted_track</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>

<span class="n">fit_mnm</span><span class="p">(</span><span class="n">fit_mnm_debug</span><span class="p">):</span>
  <span class="n">maxI</span><span class="p">:</span> <span class="mi">10</span>
  <span class="n">get_elbo</span><span class="p">:</span> <span class="n">FALSE</span>

<span class="kn">fit_varbvs:</span> <span class="n">setup_varbvs</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> <span class="n">fit_varbvs</span><span class="o">.</span><span class="n">R</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="n">varbvs</span><span class="nd">@pcarbo</span><span class="o">/</span><span class="n">varbvs</span><span class="o">/</span><span class="n">varbvs</span><span class="o">-</span><span class="n">R</span>
  <span class="n">sa</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>
  <span class="err">$</span><span class="n">fitted</span><span class="p">:</span> <span class="n">fitted</span>

<span class="kn">fit_caviar:</span> <span class="n">fit_caviar</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> \
             <span class="n">R</span><span class="p">(</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">finemap_mcaviar</span><span class="p">(</span><span class="n">sumstats</span><span class="p">[</span><span class="mi">1</span><span class="p">,,]</span><span class="o">/</span><span class="n">sumstats</span><span class="p">[</span><span class="mi">2</span><span class="p">,,],</span> 
                                            <span class="n">ld</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">cache</span><span class="p">))</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dplyr</span><span class="p">,</span> <span class="n">magrittr</span><span class="p">)</span>
  <span class="n">sumstats</span><span class="p">:</span> <span class="err">$</span><span class="n">sumstats</span>
  <span class="n">ld</span><span class="p">:</span> <span class="err">$</span><span class="n">ld_file</span>
  <span class="n">args</span><span class="p">:</span> <span class="s2">&quot;-c 1&quot;</span><span class="p">,</span> <span class="s2">&quot;-c 2&quot;</span><span class="p">,</span> <span class="s2">&quot;-c 3&quot;</span>
  <span class="n">cache</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">CAVIAR</span><span class="p">)</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>

<span class="n">fit_finemap</span><span class="p">(</span><span class="n">fit_caviar</span><span class="p">):</span> <span class="n">fit_finemap</span><span class="o">.</span><span class="n">R</span> <span class="o">+</span> \
             <span class="n">R</span><span class="p">(</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">finemap_mvar</span><span class="p">(</span><span class="n">sumstats</span><span class="p">[</span><span class="mi">1</span><span class="p">,,],</span> <span class="n">sumstats</span><span class="p">[</span><span class="mi">2</span><span class="p">,,],</span>
                                        <span class="n">data</span><span class="err">$</span><span class="n">allele_freq</span><span class="p">,</span>
                                        <span class="n">ld</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span>
                                        <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">cache</span><span class="p">))</span>
  <span class="n">N</span><span class="p">:</span> <span class="err">$</span><span class="n">N</span>
  <span class="n">k</span><span class="p">:</span> <span class="n">NULL</span> <span class="c1">#, (0.6,0.2,0.1,0.05,0.05)</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">args</span><span class="p">:</span> <span class="s2">&quot;--n-causal-snps 5&quot;</span>
  <span class="n">cache</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">FM</span><span class="p">)</span>

<span class="kn">fit_dap:</span> <span class="n">fit_dap</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> <span class="n">Python</span><span class="p">(</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">dap_batch</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">cache</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">args</span><span class="p">:</span> <span class="s2">&quot;-ld_control 0.20 --all&quot;</span>
  <span class="n">cache</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>

<span class="kn">fit_dap_z:</span> <span class="n">fit_dap</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> <span class="n">Python</span><span class="p">(</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">dap_batch_z</span><span class="p">(</span><span class="n">sumstats</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">/</span><span class="n">sumstats</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:],</span>
                                                       <span class="n">ld</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
  <span class="n">sumstats</span><span class="p">:</span> <span class="err">$</span><span class="n">sumstats</span>
  <span class="n">ld</span><span class="p">:</span> <span class="err">$</span><span class="n">ld_file</span>
  <span class="n">args</span><span class="p">:</span> <span class="s2">&quot;-t 4&quot;</span>
  <span class="n">cache</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">DAP</span><span class="p">)</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>

<span class="c1"># fit_dap_mv(fit_dap): fit_dap.py + Python(res = dap_mv())</span>
<span class="c1"># fit_dap_mv_ss(fit_dap): fit_dap.py + Python(res = dap_mv_ss())</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit.dsc" target="_blank">modules/fit.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_susie.dsc"><code>fit_susie.dsc</code><a class="anchor-link" href="#fit_susie.dsc">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_susie</span><span class="o">.</span><span class="n">dsc</span>
<span class="kn">fit_susie:</span> <span class="n">fit_susie</span><span class="o">.</span><span class="n">R</span>
  <span class="c1"># Prior variance of nonzero effects.</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="n">susieR</span><span class="nd">@stephenslab</span><span class="o">/</span><span class="n">susieR</span>
  <span class="n">maxI</span><span class="p">:</span> <span class="mi">200</span>
  <span class="n">maxL</span><span class="p">:</span> <span class="mi">5</span>
  <span class="n">estimate_residual_variance</span><span class="p">:</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span>
  <span class="n">prior_var</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span>
  <span class="n">auto</span><span class="p">:</span> <span class="n">FALSE</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="err">$</span><span class="n">posterior</span><span class="p">:</span> <span class="n">posterior</span>
  <span class="err">$</span><span class="n">fitted</span><span class="p">:</span> <span class="n">fitted</span>

<span class="n">fit_susie01</span><span class="p">(</span><span class="n">fit_susie</span><span class="p">):</span>
  <span class="n">maxL</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_susie.dsc" target="_blank">modules/fit_susie.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="evaluate.dsc"><code>evaluate.dsc</code><a class="anchor-link" href="#evaluate.dsc">&#182;</a></h3><p>Methods evaluation / visualization.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">evaluate</span><span class="o">.</span><span class="n">dsc</span>
<span class="c1"># Modules to evaluate various methods</span>
<span class="c1"># for finemapping-m</span>

<span class="c1"># Module input</span>
<span class="c1"># ============</span>
<span class="c1"># $fit: see fit.dsc</span>
<span class="c1"># $result: see fit.dsc</span>

<span class="c1"># Module output</span>
<span class="c1"># =============</span>
<span class="c1"># ? an object or plot for diagnosis</span>

<span class="kn">plot_finemap:</span> <span class="n">plot_finemap</span><span class="o">.</span><span class="n">R</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">R_libs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dplyr</span><span class="p">,</span> <span class="n">ggplot2</span><span class="p">,</span> <span class="n">cowplot</span><span class="p">)</span>
  <span class="n">result</span><span class="p">:</span> <span class="err">$</span><span class="n">posterior</span>
  <span class="n">top_rank</span><span class="p">:</span> <span class="mi">10</span>
  <span class="err">$</span><span class="n">plot_file</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>

<span class="n">plot_caviar</span><span class="p">(</span><span class="n">plot_finemap</span><span class="p">):</span> <span class="n">plot_caviar</span><span class="o">.</span><span class="n">R</span>
<span class="n">plot_dap</span><span class="p">(</span><span class="n">plot_finemap</span><span class="p">):</span> <span class="n">plot_dap</span><span class="o">.</span><span class="n">R</span>

<span class="kn">plot_sse:</span> <span class="n">lib_regression_simulator</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
            <span class="n">plot_sse</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> \
            <span class="n">Python</span><span class="p">(</span><span class="n">plot_sse</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;PosteriorMean&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">],</span>
                            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;in_CI&#39;</span><span class="p">],</span> <span class="n">ld_mat</span><span class="p">,</span> <span class="n">plot_file</span><span class="p">))</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">python_modules</span> <span class="o">=</span> <span class="n">seaborn</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">result</span><span class="p">:</span> <span class="err">$</span><span class="n">posterior</span>
  <span class="n">ld_mat</span><span class="p">:</span> <span class="err">$</span><span class="n">ld_mat</span>
  <span class="err">$</span><span class="n">plot_file</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>

<span class="kn">plot_susie:</span> <span class="n">plot_susie</span><span class="o">.</span><span class="n">py</span> <span class="o">+</span> <span class="n">Python</span><span class="p">(</span><span class="n">purity</span><span class="p">,</span> <span class="n">signal</span> <span class="o">=</span> <span class="n">plot_sets</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;in_CI&#39;</span><span class="p">],</span> 
                                                              <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lfsr&#39;</span><span class="p">],</span>
                                                              <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">],</span>
                                                              <span class="n">ld_mat</span><span class="p">,</span>
                                                              <span class="n">seg</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">))</span>
  <span class="nd">@CONF</span><span class="p">:</span> <span class="n">python_modules</span> <span class="o">=</span> <span class="n">seaborn</span>
  <span class="n">data</span><span class="p">:</span> <span class="err">$</span><span class="n">data</span>
  <span class="n">result</span><span class="p">:</span> <span class="err">$</span><span class="n">posterior</span>
  <span class="n">ld_mat</span><span class="p">:</span> <span class="err">$</span><span class="n">ld_mat</span>
  <span class="n">save_plot</span><span class="p">:</span> <span class="bp">True</span>                                                            
  <span class="err">$</span><span class="n">seg</span><span class="p">:</span> <span class="nb">file</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
  <span class="err">$</span><span class="n">purity</span><span class="p">:</span> <span class="n">purity</span>
  <span class="err">$</span><span class="n">signal</span><span class="p">:</span> <span class="n">signal</span>
                                                              
<span class="n">eval_susie</span><span class="p">(</span><span class="n">plot_susie</span><span class="p">):</span>
  <span class="n">save_plot</span><span class="p">:</span> <span class="bp">False</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/evaluate.dsc" target="_blank">modules/evaluate.dsc</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Workhorses">Workhorses<a class="anchor-link" href="#Workhorses">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sim_utils.R"><code>sim_utils.R</code><a class="anchor-link" href="#sim_utils.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">sim_utils</span><span class="o">.</span><span class="n">R</span>
<span class="n">get_center</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">## For given number k, get the range k surrounding n/2</span>
  <span class="c1">## but have to make sure it does not go over the bounds</span>
  <span class="n">start</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">end</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="o">&gt;</span><span class="n">n</span><span class="p">)</span> <span class="n">end</span> <span class="o">=</span> <span class="n">n</span>
  <span class="k">return</span><span class="p">(</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/sim_utils.R" target="_blank">modules/sim_utils.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="regression.R"><code>regression.R</code><a class="anchor-link" href="#regression.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">regression</span><span class="o">.</span><span class="n">R</span>
<span class="c1">## Perform univariate regression for each column of Y on each column of X</span>
<span class="n">univariate_regression</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">NULL</span><span class="p">,</span> <span class="n">return_residue</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="err">$</span><span class="n">residuals</span>
  <span class="p">}</span>
  <span class="n">calc_stderr</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># S = (X&#39;X)^-1 \Sigma</span>
    <span class="n">sqrt</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chol2inv</span><span class="p">(</span><span class="n">chol</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">))))</span>
  <span class="p">}</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span>
                   <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                     <span class="n">g</span> <span class="o">=</span> <span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="p">[,</span><span class="n">i</span><span class="p">]),</span> <span class="n">y</span><span class="p">)</span>
                     <span class="k">return</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">g</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">calc_stderr</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="p">[,</span><span class="n">i</span><span class="p">]),</span> <span class="n">g</span><span class="err">$</span><span class="n">residuals</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
                   <span class="p">})</span>
                   <span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">return_residue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">betahat</span> <span class="o">=</span> <span class="n">output</span><span class="p">[,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sebetahat</span> <span class="o">=</span> <span class="n">output</span><span class="p">[,</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">betahat</span> <span class="o">=</span> <span class="n">output</span><span class="p">[,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sebetahat</span> <span class="o">=</span> <span class="n">output</span><span class="p">[,</span><span class="mi">2</span><span class="p">]))</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">library</span><span class="p">(</span><span class="n">abind</span><span class="p">)</span>
<span class="n">mm_regression</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">reg</span> <span class="o">=</span> <span class="n">lapply</span><span class="p">(</span><span class="n">seq_len</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">Y</span><span class="p">)),</span> <span class="n">function</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">simplify2array</span><span class="p">(</span><span class="n">univariate_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">[,</span><span class="n">i</span><span class="p">])))</span>
  <span class="n">reg</span> <span class="o">=</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">abind</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">along</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
  <span class="c1"># return array: out[1,,] is betahat, out[2,,] is shat</span>
  <span class="k">return</span><span class="p">(</span><span class="n">aperm</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/regression.R" target="_blank">modules/regression.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="setup_varbvs.R"><code>setup_varbvs.R</code><a class="anchor-link" href="#setup_varbvs.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">setup_varbvs</span><span class="o">.</span><span class="n">R</span>

<span class="n">X</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="err">$</span><span class="n">X</span>
<span class="n">storage</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s2">&quot;double&quot;</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="n">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X</span> <span class="o">&lt;-</span> <span class="n">scale</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span>
<span class="n">alpha0</span>  <span class="o">&lt;-</span> <span class="n">runif</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">alpha0</span>  <span class="o">&lt;-</span> <span class="n">alpha0</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">alpha0</span><span class="p">)</span>
<span class="n">mu0</span>     <span class="o">&lt;-</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">pp</span>      <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="n">maxL</span><span class="o">/</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">logodds</span> <span class="o">&lt;-</span> <span class="n">varbvs</span><span class="p">:::</span><span class="n">logit</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="err">$</span><span class="n">Y</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">])</span>
<span class="p">}</span>
<span class="n">storage</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s2">&quot;double&quot;</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/setup_varbvs.R" target="_blank">modules/setup_varbvs.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_varbvs.R"><code>fit_varbvs.R</code><a class="anchor-link" href="#fit_varbvs.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_varbvs</span><span class="o">.</span><span class="n">R</span>
<span class="n">fitted</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">sigma</span> <span class="o">&lt;-</span> <span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">])</span>
  <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">varbvs</span><span class="p">::</span><span class="n">varbvsnorm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">],</span><span class="n">sigma</span><span class="p">,</span><span class="n">sa</span><span class="p">,</span><span class="n">logodds</span><span class="p">,</span><span class="n">alpha0</span><span class="p">,</span><span class="n">mu0</span><span class="p">,</span><span class="n">update</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span>
                                    <span class="n">update</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span><span class="n">update</span><span class="o">.</span><span class="n">sa</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxI</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">post_mean</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">mu</span><span class="p">))</span>
<span class="n">lfdr</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">alpha</span><span class="p">))</span>
<span class="n">posterior</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">(</span><span class="n">PosteriorMean</span><span class="o">=</span><span class="n">post_mean</span><span class="p">,</span> <span class="n">lfdr</span><span class="o">=</span><span class="n">lfdr</span><span class="p">,</span> <span class="n">in_CI</span><span class="o">=</span><span class="n">NULL</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_varbvs.R" target="_blank">modules/fit_varbvs.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="init_mnm.R"><code>init_mnm.R</code><a class="anchor-link" href="#init_mnm.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">init_mnm</span><span class="o">.</span><span class="n">R</span>
<span class="c1"># Initialize model data: priors and init values</span>

<span class="k">if</span> <span class="p">(</span><span class="n">Sigma</span> <span class="o">!=</span> <span class="s1">&#39;empirical&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1"># FIXME data$V has to be changed</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="p">}</span>
<span class="n">mash_data</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">,,],</span> <span class="n">Shat</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">,,],</span> <span class="n">V</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="k">if</span> <span class="p">(</span><span class="n">U</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_canonical</span><span class="p">(</span><span class="n">mash_data</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">## FIXME: add other methods to get U</span>
  <span class="n">U</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_canonical</span><span class="p">(</span><span class="n">mash_data</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">model</span><span class="err">$</span><span class="n">fitted_g</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash</span><span class="p">(</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">Ulist</span><span class="o">=</span><span class="n">U</span><span class="p">,</span> <span class="n">outputlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usepointmass</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span><span class="err">$</span><span class="n">fitted_g</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">## FIXME: need to use pre-fitted pi on larger data from mash procedure</span>
  <span class="n">model</span><span class="err">$</span><span class="n">fitted_g</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pi</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">Ulist</span><span class="o">=</span><span class="n">U</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">usepointmass</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/init_mnm.R" target="_blank">modules/init_mnm.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="elbo_mnm.R"><code>elbo_mnm.R</code><a class="anchor-link" href="#elbo_mnm.R">&#182;</a></h3><p>Here we compute ELBO along the lines of the FLASH paper: justify that it is the multivariate normal-mean problem (MASH), then computer ELBO mostly using MASH updates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">elbo_mnm</span><span class="o">.</span><span class="n">R</span>
<span class="c1">#&#39; @title Residual covariance for a M&amp;M fit</span>
<span class="c1">#&#39; B is J X R matrix of M&amp;M output</span>
<span class="c1">#&#39; SM is J X R X R matrix of M&amp;M output with 2nd moment option on</span>
<span class="c1">#&#39; XtX is just precomputed t(X) %*% X</span>
<span class="n">compute_mnm_residual_covariance</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">XtX</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">SM</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># out = t(Y) %*% Y - 2 * t(B) %*% t(X) %*% Y # + E[B^TX^TXB]</span>
    <span class="c1"># E[B^TX^TXB] is not easy to compute properly</span>
    <span class="c1"># use MLE for now</span>
    <span class="k">return</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X</span><span class="o">%*%</span><span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">X</span><span class="o">%*%</span><span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
<span class="p">}</span> 
                                            
<span class="c1">#&#39; @title expected loglikelihood for a M&amp;M fit</span>
<span class="c1"># https://gaow.github.io/mvarbvs/writeup/20171215_MNMModel_Finemap.html</span>
<span class="c1">#&#39; S is simply XtX pre-computed</span>
<span class="c1">#&#39; Sigma is current estimate of residual variance</span>
<span class="c1">#&#39; B is J X R matrix of M&amp;M output</span>
<span class="c1">#&#39; SM is J X R X R matrix of M&amp;M output with 2nd moment option on</span>
<span class="n">compute_mnm_Eloglik</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Sigma</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">SM</span><span class="p">){</span>
    <span class="n">inv_Sigma</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
    <span class="n">det_Sigma</span> <span class="o">=</span> <span class="n">det</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">nrow</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">ncol</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">vector</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">t0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">inv_Sigma</span> <span class="o">*</span> <span class="n">SM</span><span class="p">[,,</span><span class="n">j</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">inv_Sigma</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">S</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">))</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="o">-</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">Y</span> <span class="o">%*%</span> <span class="n">inv_Sigma</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span> <span class="o">+</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">Y</span> <span class="o">%*%</span> <span class="n">inv_Sigma</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">det_Sigma</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">t1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#&#39; @title posterior expected loglikelihood for a MASH problem</span>
<span class="c1">## E[log(\hat{B}|B, Shat)]</span>
<span class="c1">## Need posterior mean and posterior second moment from MASH</span>
<span class="c1">## do not use any computational trick here because this is </span>
<span class="c1">## just for sanity check</span>
<span class="n">compute_mash_Eloglik</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">betahat</span><span class="p">,</span> <span class="n">Shat</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">inv_Shat</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">Shat</span><span class="p">)</span>
    <span class="n">det_Shat</span> <span class="o">=</span> <span class="n">det</span><span class="p">(</span><span class="n">Shat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">nrow</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">det_Shat</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">betahat</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">inv_Shat</span> <span class="o">%*%</span> <span class="n">betahat</span> <span class="o">-</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">(</span><span class="n">betahat</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">inv_Shat</span> <span class="o">%*%</span> <span class="n">b</span> <span class="o">+</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">inv_Shat</span> <span class="o">%*%</span> <span class="n">b2</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#&#39; @title sum of MASH posterior expected loglikelihood</span>
<span class="c1">#&#39; Bhat is J x R matrix of MASH input</span>
<span class="c1">#&#39; SDhat is J X R matrix to be expanded with V, turning into J X R X R</span>
<span class="c1">#&#39; V is R X R matrix of MASH input</span>
<span class="c1">#&#39; Sigma is residual variance</span>
<span class="c1">#&#39; alpah is a J vector of weights</span>
<span class="c1">#&#39; B is J X R matrix of MASH output</span>
<span class="c1">#&#39; SM is J X R X R matrix of MASH output with 2nd moment option on</span>
<span class="n">compute_sse_Eloglik</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">Bhat</span><span class="p">,</span> <span class="n">SDhat</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">Sigma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">SM</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">## FIXME: I think it is wrong here because it is not single effect model</span>
    <span class="c1">## where J effects should NOT be factorized.</span>
    <span class="c1">## But otherwise isn&#39;t it a matrix normal density with both row and column covariances?</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">vector</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">Bhat</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">## Is R X R</span>
        <span class="n">Shat</span> <span class="o">=</span> <span class="n">SDhat</span><span class="p">[</span><span class="n">j</span><span class="p">,]</span> <span class="o">*</span> <span class="n">t</span><span class="p">(</span><span class="n">V</span> <span class="o">*</span> <span class="n">SDhat</span><span class="p">[</span><span class="n">j</span><span class="p">,])</span> <span class="c1"># faster than diag(SDhat[j,]) %*% V %*% diag(SDhat[j,])</span>
        <span class="c1">## Is R X 1</span>
        <span class="n">B_j</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,]</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1">## 2nd moment, R X R</span>
        <span class="n">B2_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,]</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,])</span> <span class="o">+</span> <span class="n">SM</span><span class="p">[,,</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_mash_Eloglik</span><span class="p">(</span><span class="n">Bhat</span><span class="p">[</span><span class="n">j</span><span class="p">,],</span> <span class="n">Shat</span><span class="p">,</span> <span class="n">B_j</span><span class="p">,</span> <span class="n">B2_j</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/elbo_mnm.R" target="_blank">modules/elbo_mnm.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_mnm.R"><code>fit_mnm.R</code><a class="anchor-link" href="#fit_mnm.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_mnm</span><span class="o">.</span><span class="n">R</span>
<span class="c1">## M&amp;M ash module core update</span>
<span class="n">mnm_update_model</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">fitted_g</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">get_kl</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">## &quot;fitted&quot; include p_alpha, alpha, mu and Xr</span>
  <span class="n">maxL</span> <span class="o">=</span> <span class="n">ncol</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">maxL</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">## remove the lth effect</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">Xr</span> <span class="o">&lt;-</span> <span class="n">fitted</span><span class="err">$</span><span class="n">Xr</span> <span class="o">-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]])</span>
    <span class="c1">## update mash model</span>
    <span class="n">reg</span> <span class="o">&lt;-</span> <span class="n">mm_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">fitted</span><span class="err">$</span><span class="n">Xr</span><span class="p">)</span>
    <span class="n">mash_data</span> <span class="o">&lt;-</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">,,],</span> <span class="n">Shat</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">,,],</span> <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">mout</span> <span class="o">&lt;-</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash</span><span class="p">(</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">fitted_g</span><span class="p">,</span> <span class="n">fixg</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">outputlevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">## update fitted values</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">PosteriorMean</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">s</span><span class="p">[[</span><span class="n">l</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">PosteriorCov</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">lfsr</span><span class="p">[[</span><span class="n">l</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">lfsr</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">neg</span><span class="p">[[</span><span class="n">l</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">NegativeProb</span>
    <span class="n">l10bf</span> <span class="o">&lt;-</span> <span class="n">mashr</span><span class="p">::</span><span class="n">get_log10bf</span><span class="p">(</span><span class="n">mout</span><span class="p">)</span>
    <span class="c1">## FIXME: mashr issue 35</span>
    <span class="n">l10bf</span><span class="p">[</span><span class="ow">is</span><span class="o">.</span><span class="n">infinite</span><span class="p">(</span><span class="n">l10bf</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="nb">range</span><span class="p">(</span><span class="n">l10bf</span><span class="p">,</span> <span class="n">finite</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">alpha_post</span> <span class="o">&lt;-</span> <span class="n">exp</span><span class="p">((</span><span class="n">l10bf</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">l10bf</span><span class="p">))</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">p_alpha</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">alpha_post</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">alpha_post</span><span class="p">)</span>
    <span class="c1">## add back the updated lth effect</span>
    <span class="n">fitted</span><span class="err">$</span><span class="n">Xr</span> <span class="o">&lt;-</span> <span class="n">fitted</span><span class="err">$</span><span class="n">Xr</span> <span class="o">+</span> <span class="n">X</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">get_kl</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># Justified by A.46 of FLASH paper</span>
        <span class="c1"># Here KL is denoted as (13.28) of BDA 3</span>
        <span class="n">fitted</span><span class="err">$</span><span class="n">kl</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">mout</span><span class="err">$</span><span class="n">loglik</span> <span class="o">+</span> <span class="n">compute_sse_Eloglik</span><span class="p">(</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">,,],</span> <span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">,,],</span> <span class="n">V</span><span class="p">,</span>
                                                               <span class="n">fitted</span><span class="err">$</span><span class="n">Sigma</span><span class="p">,</span> 
                                                               <span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">],</span>
                                                               <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">PosteriorMean</span><span class="p">,</span>
                                                               <span class="n">mout</span><span class="err">$</span><span class="n">result</span><span class="err">$</span><span class="n">PosteriorCov</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">## Compute posterior mean and covariances</span>
<span class="n">mnm_compute_posterior_matrices</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">post_mean</span> <span class="o">&lt;-</span> <span class="n">matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">post_mean</span> <span class="o">&lt;-</span> <span class="n">post_mean</span> <span class="o">+</span> <span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]]</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">post_cov</span> <span class="o">&lt;-</span> <span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">J</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">post_cov</span><span class="p">[,,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">post_cov</span><span class="p">[,,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]][</span><span class="n">j</span><span class="p">,]</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">mu</span><span class="p">[[</span><span class="n">l</span><span class="p">]][</span><span class="n">j</span><span class="p">,])</span> <span class="o">+</span> <span class="n">fitted</span><span class="err">$</span><span class="n">s</span><span class="p">[[</span><span class="n">l</span><span class="p">]][,,</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">]</span>
      <span class="p">}</span>
      <span class="n">post_cov</span><span class="p">[,,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">post_cov</span><span class="p">[,,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">post_mean</span><span class="p">[</span><span class="n">j</span><span class="p">,]</span> <span class="o">%*%</span> <span class="n">t</span><span class="p">(</span><span class="n">post_mean</span><span class="p">[</span><span class="n">j</span><span class="p">,])</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">PosteriorMean</span> <span class="o">=</span> <span class="n">post_mean</span><span class="p">,</span> <span class="n">PosteriorCov</span> <span class="o">=</span> <span class="n">post_cov</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">## Initialize storage for results</span>
<span class="n">data</span><span class="err">$</span><span class="n">X</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">)</span>
<span class="n">data</span><span class="err">$</span><span class="n">Y</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">)</span>
<span class="n">maxL</span> <span class="o">&lt;-</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxL</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">))</span>
<span class="n">p_alpha</span> <span class="o">&lt;-</span> <span class="n">rep</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">))</span> <span class="o">/</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="n">matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> <span class="n">maxL</span><span class="p">)</span>
<span class="n">mu</span> <span class="o">&lt;-</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">maxL</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">)))</span>
<span class="n">Xr</span> <span class="o">&lt;-</span> <span class="n">matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">),</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">))</span>
<span class="n">fitted</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">(</span><span class="n">p_alpha</span><span class="o">=</span><span class="n">p_alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">Xr</span><span class="o">=</span><span class="n">Xr</span><span class="p">,</span> <span class="n">kl</span><span class="o">=</span><span class="n">vector</span><span class="p">(),</span> <span class="n">lfsr</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">neg</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">V</span><span class="p">)</span>
<span class="n">fitted_track</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">Vcorr</span> <span class="o">&lt;-</span> <span class="n">cov2cor</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="c1">## For ELBO</span>
<span class="n">XtX</span> <span class="o">&lt;-</span> <span class="n">t</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">data</span><span class="err">$</span><span class="n">X</span>
<span class="c1">## Fit m&amp;m model</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">maxI</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fitted</span> <span class="o">&lt;-</span> <span class="n">mnm_update_model</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">,</span> <span class="n">Vcorr</span><span class="p">,</span> <span class="n">model</span><span class="err">$</span><span class="n">fitted_g</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">get_elbo</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">get_elbo</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">post_mat</span> <span class="o">=</span> <span class="n">mnm_compute_posterior_matrices</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">),</span> <span class="n">maxL</span><span class="p">)</span>
      <span class="n">fitted</span><span class="err">$</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">compute_mnm_residual_covariance</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">,</span> <span class="n">XtX</span><span class="p">,</span>
                                                     <span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorMean</span><span class="p">,</span> 
                                                     <span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorCov</span><span class="p">)</span>
      <span class="n">fitted</span><span class="err">$</span><span class="n">post_loglik</span> <span class="o">=</span> <span class="n">compute_mnm_Eloglik</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">,</span> 
                                          <span class="n">XtX</span><span class="p">,</span> <span class="n">fitted</span><span class="err">$</span><span class="n">Sigma</span><span class="p">,</span>
                                          <span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorMean</span><span class="p">,</span> 
                                          <span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorCov</span><span class="p">)</span>
      <span class="n">fitted</span><span class="err">$</span><span class="n">elbo</span> <span class="o">=</span> <span class="n">fitted</span><span class="err">$</span><span class="n">post_loglik</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">kl</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">fitted_track</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">fitted</span>
<span class="p">}</span>

<span class="n">post_mat</span> <span class="o">=</span> <span class="n">mnm_compute_posterior_matrices</span><span class="p">(</span><span class="n">fitted</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">),</span> <span class="n">maxL</span><span class="p">)</span>

<span class="c1">## Compute lfsr</span>
<span class="n">lfsr</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">maxL</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="n">colSums</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">[,</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">fitted</span><span class="err">$</span><span class="n">lfsr</span><span class="p">[[</span><span class="n">l</span><span class="p">]])))</span>
<span class="n">posterior</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">(</span><span class="n">PosteriorMean</span><span class="o">=</span><span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorMean</span><span class="p">,</span>
                  <span class="n">PosteriorCov</span><span class="o">=</span><span class="n">post_mat</span><span class="err">$</span><span class="n">PosteriorCov</span><span class="p">,</span>
                  <span class="n">alpha</span> <span class="o">=</span> <span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">,</span>
                  <span class="n">lfsr</span><span class="o">=</span><span class="n">lfsr</span><span class="p">,</span>
                  <span class="n">n_in_CI</span><span class="o">=</span><span class="n">susieR</span><span class="p">:::</span><span class="n">n_in_CI</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">)),</span>
                  <span class="n">in_CI</span><span class="o">=</span><span class="n">susieR</span><span class="p">:::</span><span class="n">in_CI</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">fitted</span><span class="err">$</span><span class="n">alpha</span><span class="p">))</span>
                  <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_mnm.R" target="_blank">modules/fit_mnm.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_susie.R"><code>fit_susie.R</code><a class="anchor-link" href="#fit_susie.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_susie</span><span class="o">.</span><span class="n">R</span>
<span class="n">fitted</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">auto</span><span class="p">)</span>
      <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">::</span><span class="n">susie_auto</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">,</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">])</span>
  <span class="k">else</span>
      <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">::</span><span class="n">susie</span><span class="p">(</span><span class="n">data</span><span class="err">$</span><span class="n">X</span><span class="p">,</span><span class="n">data</span><span class="err">$</span><span class="n">Y</span><span class="p">[,</span><span class="n">r</span><span class="p">],</span>
                               <span class="n">L</span><span class="o">=</span><span class="n">maxL</span><span class="p">,</span>
                               <span class="n">max_iter</span><span class="o">=</span><span class="n">maxI</span><span class="p">,</span>
                               <span class="n">estimate_residual_variance</span> <span class="o">=</span> <span class="n">estimate_residual_variance</span><span class="p">,</span> 
                               <span class="n">prior_variance</span><span class="o">=</span><span class="n">prior_var</span><span class="p">,</span> 
                               <span class="n">intercept</span><span class="o">=</span><span class="n">FALSE</span><span class="p">,</span>
                               <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
  <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span><span class="err">$</span><span class="n">lfsr</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">::</span><span class="n">susie_get_lfsr</span><span class="p">(</span><span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]])</span>
  <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span><span class="err">$</span><span class="n">n_in_CI</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">:::</span><span class="n">n_in_CS</span><span class="p">(</span><span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]])</span>
  <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span><span class="err">$</span><span class="n">in_CI</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">::</span><span class="n">susie_in_CS</span><span class="p">(</span><span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]])</span>
  <span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]]</span><span class="err">$</span><span class="n">niter</span> <span class="o">&lt;-</span> <span class="n">susieR</span><span class="p">:::</span><span class="n">susie_get_niter</span><span class="p">(</span><span class="n">fitted</span><span class="p">[[</span><span class="n">r</span><span class="p">]])</span>
<span class="p">}</span>

<span class="n">posterior</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">(</span><span class="n">PosteriorMean</span><span class="o">=</span><span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">susieR</span><span class="p">:::</span><span class="n">coef</span><span class="o">.</span><span class="n">susie</span><span class="p">(</span><span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]))),</span>
                  <span class="n">lfsr</span><span class="o">=</span><span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">lfsr</span><span class="p">)),</span>
                  <span class="n">alpha</span><span class="o">=</span><span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">alpha</span><span class="p">),</span>
                  <span class="n">in_CI</span><span class="o">=</span><span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">in_CI</span><span class="p">),</span>
                  <span class="n">n_in_CI</span><span class="o">=</span><span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">n_in_CI</span><span class="p">)),</span>
                  <span class="n">niter</span> <span class="o">=</span> <span class="n">sapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="n">fitted</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="err">$</span><span class="n">niter</span><span class="p">)</span>                              
                  <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_susie.R" target="_blank">modules/fit_susie.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_dap.py"><code>fit_dap.py</code><a class="anchor-link" href="#fit_dap.py">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>DAP version 1 was published as Wen et al 2016 AJHG. Here William has polished the software <code>dap-g</code> with another manuscript that describes improved algorithm and working with summary statistics. This benchmark uses DAP version 2. Below is an example output that I parse and save.</p>

<pre><code>Posterior expected model size: 0.500 (sd = 0.500)
LogNC = -0.30685 ( Log10NC = -0.133 )
Posterior inclusion probability

((1))              7492 6.68581e-05       0.000 1
((2))              7490 6.68581e-05       0.000 1
... 7 lines
((8))              7491 6.68046e-05       0.000 2
((9))              7483 6.68046e-05       0.000 2
((10))             7485 6.68046e-05       0.000 2
... 13 lines
((20))             7459 6.68046e-05       0.000 2
((21))             7482 6.67422e-05       0.000 -1
((22))             7489 6.67422e-05       0.000 -1
... other lines until below ...

Independent association signal clusters

     cluster         member_snp      cluster_pip      average_r2
       {1}              7            4.680e-04          0.951                 0.951   0.037
       {2}             13            8.685e-04          0.623                 0.037   0.623</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_dap</span><span class="o">.</span><span class="n">py</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">write_dap_full</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="s1">&#39;geno&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;group{r}&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{prefix}.data&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="s1">&#39;pheno&#39;</span><span class="p">,</span> <span class="s1">&#39;pheno&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;group{r}&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())),</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">names</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="c1">#     grid = &#39;&#39;&#39;         </span>
<span class="c1">#         0.0000  0.1000</span>
<span class="c1">#         0.0000  0.2000</span>
<span class="c1">#         0.0000  0.4000</span>
<span class="c1">#         0.0000  0.8000</span>
<span class="c1">#         0.0000  1.6000</span>
<span class="c1">#         &#39;&#39;&#39;</span>
<span class="c1">#     grid = &#39;\n&#39;.join([x.strip() for x in grid.strip().split(&#39;\n&#39;)])</span>
<span class="c1">#     with open(f&#39;{prefix}.grid&#39;, &#39;w&#39;) as f:</span>
<span class="c1">#         print(grid, file=f)</span>
        
<span class="k">def</span> <span class="nf">run_dap_full</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dap-g&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{prefix}.data&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{prefix}.result&#39;</span><span class="p">,</span> <span class="s1">&#39;--output_all&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>    
           
<span class="k">def</span> <span class="nf">write_dap_ss</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;z-score vesion of dap input is the same as FINEMAP&#39;&#39;&#39;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{prefix}.z&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ids</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_dap_z</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dap-g&#39;</span><span class="p">,</span> <span class="s1">&#39;-d_z&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{prefix}.z&#39;</span><span class="p">,</span> <span class="s1">&#39;-d_ld&#39;</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{prefix}.result&#39;</span><span class="p">,</span> <span class="s1">&#39;--all&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>    
    
<span class="k">def</span> <span class="nf">extract_dap_output</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{prefix}.result&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">pips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">still_pip</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cluster_pip&#39;</span><span class="p">:</span>
            <span class="n">still_pip</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">still_pip</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;((&#39;</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">still_pip</span><span class="p">:</span>
            <span class="n">pips</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])])</span>
    <span class="n">pips</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pips</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snp&#39;</span><span class="p">,</span> <span class="s1">&#39;snp_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;snp_log10bf&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">])</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster_avg_r2&#39;</span><span class="p">])</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">pips</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">])[</span><span class="s1">&#39;snp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;cluster&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;snp&#39;</span><span class="p">:</span> <span class="n">pips</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="n">clusters</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">dap_single</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">write_dap_full</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="n">run_dap_full</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extract_dap_output</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dap_single_z</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">write_dap_ss</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">run_dap_z</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extract_dap_output</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dap_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">r</span><span class="p">,</span> <span class="n">dap_single</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span><span class="n">r</span><span class="p">],</span> <span class="n">f</span><span class="s1">&#39;{prefix}_condition_{r+1}&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

<span class="k">def</span> <span class="nf">dap_batch_z</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">r</span><span class="p">,</span> <span class="n">dap_single_z</span><span class="p">(</span><span class="n">z</span><span class="p">[:,</span><span class="n">r</span><span class="p">],</span> <span class="n">ld</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;{prefix}_condition_{r+1}&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_dap.py" target="_blank">modules/fit_dap.py</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_finemap.R"><code>fit_finemap.R</code><a class="anchor-link" href="#fit_finemap.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The wrapper implements an option to use parallel <code>lapply</code> which does not throw any error message (because each thread implements <code>try ... catch</code>). Only use it when all are tested to work. That is, when coding / changing the module the <code>parallel</code> switch should be turned off.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Interface difference between version 1.1 and 1.2 (suprise!)</p>
<ul>
<li><code>--n-causal-max</code> changed to <code>--n-causal-snps</code></li>
<li>Removed <code>--regions</code> option</li>
<li>Master file <code>n-ind</code> column changed to <code>n_samples</code></li>
<li>And the most lack-of-consideration change is the input Z score format: now requires 8 columns, among which a required MAF column, and use beta and se instead of z score.</li>
</ul>

<pre><code>rsid chromosome position noneff_allele eff_allele maf beta se
rs1 10 1 T C 0.35 0.0050 0.0208
rs2 10 1 A G 0.04 0.0368 0.0761
rs3 10 1 G A 0.18 0.0228 0.0199</code></pre>
<p>and it is not clear that if eff_allele has to be minor allele -- does not make sense either way.</p>
<p>Update: for some data-sets (same genotype LD different Z scores) FINEMAP will fail on error:</p>

<pre><code>Error : Maximum likelihood estimate for the residual variance from multiple regression of SNPs is not positive!</code></pre>
<p>With <code>parallel=TRUE</code> this module will not quit on error, but it will impact the plot module and cause it to fail. I've emailed the author with a test data-set. But for the time being I'll just ignore the data-sets that has this error.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_finemap</span><span class="o">.</span><span class="n">R</span>
<span class="c1">#&#39; FINEMAP I/O</span>
<span class="n">write_finemap_sumstats</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">allele_freq</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cfg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.z&quot;</span><span class="p">),</span>
             <span class="n">ld</span><span class="o">=</span><span class="n">LD_file</span><span class="p">,</span>
             <span class="n">snp</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.snp&quot;</span><span class="p">),</span>
             <span class="n">config</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.config&quot;</span><span class="p">),</span>
             <span class="n">k</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.k&quot;</span><span class="p">),</span>
             <span class="n">log</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.log&quot;</span><span class="p">),</span>
             <span class="n">meta</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.master&quot;</span><span class="p">))</span>
  <span class="c1"># get dataset.z</span>
  <span class="n">J</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">bhat</span><span class="p">)</span>
  <span class="c1"># FIXME: using minor allele frequency does not make sense</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">cbind</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">J</span><span class="p">,</span> <span class="n">rep</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="p">),</span> <span class="n">rep</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span><span class="p">),</span> <span class="n">rep</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="n">J</span><span class="p">),</span> <span class="n">rep</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="n">J</span><span class="p">),</span> 
            <span class="n">pmin</span><span class="p">(</span><span class="n">allele_freq</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">allele_freq</span><span class="p">),</span> <span class="n">bhat</span><span class="p">,</span> <span class="n">se</span><span class="p">)</span>
  <span class="n">colnames</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;rsid&#39;</span><span class="p">,</span> <span class="s1">&#39;chromosome&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;noneff_allele&#39;</span><span class="p">,</span> <span class="s1">&#39;eff_allele&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;maf&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">)</span>
  <span class="n">write</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">cfg</span><span class="err">$</span><span class="n">z</span><span class="p">,</span><span class="n">quote</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">write</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">cfg</span><span class="err">$</span><span class="n">k</span><span class="p">,</span><span class="n">quote</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="s2">&quot;z;ld;snp;config;k;log;n_samples&quot;</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">cfg</span><span class="err">$</span><span class="n">meta</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">z</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">ld</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">snp</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">config</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">k</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">log</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">),</span>
        <span class="nb">file</span><span class="o">=</span><span class="n">cfg</span><span class="err">$</span><span class="n">meta</span><span class="p">,</span><span class="n">append</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">write</span><span class="p">(</span><span class="s2">&quot;z;ld;snp;config;log;n_samples&quot;</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">cfg</span><span class="err">$</span><span class="n">meta</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">z</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">ld</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">snp</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">config</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">log</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">),</span>
            <span class="nb">file</span><span class="o">=</span><span class="n">cfg</span><span class="err">$</span><span class="n">meta</span><span class="p">,</span><span class="n">append</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#&#39; Run FINEMAP version 1.2</span>
<span class="c1">#&#39; http://www.christianbenner.com</span>
<span class="c1">## FIXME: read the finemapr implementation for data sanity check.</span>
<span class="c1">## Can be useful as a general data sanity checker (in previous modules)</span>

<span class="n">run_finemap</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">allele_freq</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cfg</span> <span class="o">=</span> <span class="n">write_finemap_sumstats</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">allele_freq</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="s2">&quot;finemap --sss --log&quot;</span><span class="p">,</span> <span class="s2">&quot;--in-files&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">meta</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
  <span class="n">dscrutils</span><span class="p">::</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

  <span class="c1"># read output tables</span>
  <span class="n">snp</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">snp</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">TRUE</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)[,</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;rsid&quot;</span><span class="p">,</span> <span class="s2">&quot;prob&quot;</span><span class="p">,</span> <span class="s2">&quot;log10bf&quot;</span><span class="p">)]</span>
  <span class="n">colnames</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;snp_prob&quot;</span><span class="p">,</span> <span class="s2">&quot;snp_log10bf&quot;</span><span class="p">)</span>
  <span class="n">snp</span><span class="err">$</span><span class="n">snp</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">snp</span><span class="err">$</span><span class="n">snp</span><span class="p">)</span>

  <span class="n">snp</span> <span class="o">=</span> <span class="n">rank_snp</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">config</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">TRUE</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)[,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
  <span class="n">colnames</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;config_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;config_log10bf&#39;</span><span class="p">)</span>

  <span class="c1"># extract number of causal</span>
  <span class="n">ncausal</span> <span class="o">=</span> <span class="n">finemap_extract_ncausal</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;_sss&#39;</span><span class="p">))</span>
  <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">snp</span><span class="o">=</span><span class="n">snp</span><span class="p">,</span> <span class="nb">set</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ncausal</span><span class="o">=</span><span class="n">ncausal</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">rank_snp</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">snp</span> <span class="o">&lt;-</span> <span class="n">arrange</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="o">-</span><span class="n">snp_prob</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="n">mutate</span><span class="p">(</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">()),</span>
        <span class="n">snp_prob_cumsum</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="n">select</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">snp</span><span class="p">,</span> <span class="n">snp_prob</span><span class="p">,</span> <span class="n">snp_prob_cumsum</span><span class="p">,</span> <span class="n">snp_log10bf</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span>    
<span class="p">}</span>

<span class="n">finemap_extract_ncausal</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lines</span> <span class="o">&lt;-</span> <span class="n">grep</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">readLines</span><span class="p">(</span><span class="n">logfile</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span>
  <span class="n">lines</span> <span class="o">&lt;-</span> <span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(|</span><span class="se">\\</span><span class="s2">)|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
  <span class="n">splits</span> <span class="o">&lt;-</span> <span class="n">strsplit</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span><span class="p">)</span>
  <span class="n">tab</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span>
    <span class="n">ncausal_num</span> <span class="o">=</span> <span class="n">sapply</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
    <span class="n">ncausal_prob</span> <span class="o">=</span> <span class="n">sapply</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
  <span class="n">tab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">duplicated</span><span class="p">(</span><span class="n">ncausal_num</span><span class="p">),</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;prior&quot;</span><span class="p">))</span>
  <span class="k">return</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">finemap_mvar</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">allele_freq</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> 
                         <span class="n">parallel</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dim</span><span class="p">(</span><span class="n">bhat</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">bhat</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">bhat</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dim</span><span class="p">(</span><span class="n">se</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">se</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">se</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">single_core</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> 
      <span class="n">run_finemap</span><span class="p">(</span><span class="n">bhat</span><span class="p">[,</span><span class="n">r</span><span class="p">],</span> <span class="n">se</span><span class="p">[,</span><span class="n">r</span><span class="p">],</span> <span class="n">allele_freq</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> 
                  <span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;_condition_&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="n">parallel</span><span class="p">::</span><span class="n">mclapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">bhat</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="n">single_core</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
                                <span class="n">mc</span><span class="o">.</span><span class="kp">cores</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">bhat</span><span class="p">))))</span>
  <span class="k">else</span>
      <span class="k">return</span><span class="p">(</span><span class="n">lapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">bhat</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="n">single_core</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_finemap.R" target="_blank">modules/fit_finemap.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fit_caviar.R"><code>fit_caviar.R</code><a class="anchor-link" href="#fit_caviar.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>CAVIAR</code> output file (<code>*_post</code>):</p>
<ul>
<li>column #1 is the variant name;</li>
<li>column #2 is the <a href="https://github.com/fhormoz/caviar/issues/1#issuecomment-286521771">posterior prob. that the variant is causal</a>;</li>
<li>column #3 is the amount that this variant contributes to 95%-causal credible set.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">fit_caviar</span><span class="o">.</span><span class="n">R</span>
<span class="c1">#&#39; CAVIAR I/O</span>
<span class="n">write_caviar_sumstats</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cfg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.z&quot;</span><span class="p">),</span>
             <span class="nb">set</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;_set&quot;</span><span class="p">),</span>
             <span class="n">post</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;_post&quot;</span><span class="p">),</span>
             <span class="n">log</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;.log&quot;</span><span class="p">))</span>
  <span class="n">write</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">cfg</span><span class="err">$</span><span class="n">z</span><span class="p">,</span><span class="n">quote</span><span class="o">=</span><span class="n">F</span><span class="p">,</span><span class="n">col</span><span class="o">.</span><span class="n">names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#&#39; Run CAVIAR</span>
<span class="c1">#&#39; https://github.com/fhormoz/caviar</span>

<span class="n">run_caviar</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cfg</span> <span class="o">=</span> <span class="n">write_caviar_sumstats</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="s2">&quot;CAVIAR&quot;</span><span class="p">,</span> <span class="s2">&quot;-z&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">z</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
  <span class="n">dscrutils</span><span class="p">::</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="err">!</span><span class="nb">all</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">post</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="nb">set</span><span class="p">,</span> <span class="n">cfg</span><span class="err">$</span><span class="n">log</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Cannot find one of the post, set, and log files&quot;</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="n">log</span> <span class="o">&lt;-</span> <span class="n">readLines</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">log</span><span class="p">)</span>

  <span class="c1"># read output tables</span>
  <span class="n">snp</span> <span class="o">&lt;-</span> <span class="n">read</span><span class="o">.</span><span class="n">delim</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="n">post</span><span class="p">)</span>  
  <span class="n">stopifnot</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">names</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;snp_prob_set&quot;</span><span class="p">,</span> <span class="s2">&quot;snp_prob&quot;</span><span class="p">)</span>
  <span class="n">snp</span><span class="err">$</span><span class="n">snp</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">snp</span><span class="err">$</span><span class="n">snp</span><span class="p">)</span>
  <span class="n">snp</span> <span class="o">&lt;-</span> <span class="n">rank_snp</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span>

  <span class="c1"># `set` of snps</span>
  <span class="nb">set</span> <span class="o">&lt;-</span> <span class="n">readLines</span><span class="p">(</span><span class="n">cfg</span><span class="err">$</span><span class="nb">set</span><span class="p">)</span>
  <span class="n">set_ordered</span> <span class="o">&lt;-</span> <span class="n">left_join</span><span class="p">(</span><span class="n">data_frame</span><span class="p">(</span><span class="n">snp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">),</span> <span class="n">snp</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;snp&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
    <span class="n">arrange</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">%</span><span class="err">$</span><span class="o">%</span> <span class="n">snp</span>
  <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">snp</span><span class="o">=</span><span class="n">snp</span><span class="p">,</span> <span class="nb">set</span><span class="o">=</span><span class="n">set_ordered</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">rank_snp</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">snp</span> <span class="o">&lt;-</span> <span class="n">arrange</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="o">-</span><span class="n">snp_prob</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="n">mutate</span><span class="p">(</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">()),</span>
        <span class="n">snp_prob_cumsum</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="n">select</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">snp</span><span class="p">,</span> <span class="n">snp_prob</span><span class="p">,</span> <span class="n">snp_prob_cumsum</span><span class="p">,</span> <span class="n">snp_prob_set</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">snp</span><span class="p">)</span>    
<span class="p">}</span>

<span class="n">finemap_mcaviar</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">zscore</span><span class="p">,</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dim</span><span class="p">(</span><span class="n">zscore</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">zscore</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zscore</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">parallel</span><span class="p">::</span><span class="n">mclapply</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">zscore</span><span class="p">),</span> <span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
          <span class="n">run_caviar</span><span class="p">(</span><span class="n">zscore</span><span class="p">[,</span><span class="n">r</span><span class="p">],</span> <span class="n">LD_file</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> 
                     <span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;_condition_&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)),</span> 
                            <span class="n">mc</span><span class="o">.</span><span class="kp">cores</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">zscore</span><span class="p">))))</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/fit_caviar.R" target="_blank">modules/fit_caviar.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Visualization">Visualization<a class="anchor-link" href="#Visualization">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="plot_finemap.R"><code>plot_finemap.R</code><a class="anchor-link" href="#plot_finemap.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">plot_finemap</span><span class="o">.</span><span class="n">R</span>

<span class="n">plot_finemap</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                         <span class="n">grid_nrow</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span> 
                         <span class="n">grid_ncol</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span> 
                         <span class="n">label_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">top_rank</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                         <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span>
                         <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">label_size_config</span> <span class="o">=</span> <span class="n">label_size</span>
  <span class="n">label_size_snp</span> <span class="o">=</span> <span class="n">label_size</span>
  <span class="n">top_rank_config</span> <span class="o">=</span> <span class="n">top_rank</span>
  <span class="n">top_rank_snp</span> <span class="o">=</span> <span class="n">top_rank</span>
  <span class="n">lim_prob_config</span> <span class="o">=</span> <span class="n">lim_prob</span>
  <span class="n">lim_prob_snp</span> <span class="o">=</span> <span class="n">lim_prob</span>
  <span class="n">lim_prob_ncausal</span> <span class="o">=</span> <span class="n">lim_prob</span>   
    
  <span class="n">p1</span> <span class="o">&lt;-</span> <span class="n">plot_ncausal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
    <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">lim_prob_ncausal</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">plot_set</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  
    <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank_config</span><span class="p">,</span> 
    <span class="n">label_size</span> <span class="o">=</span> <span class="n">label_size_config</span><span class="p">,</span> 
    <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">lim_prob_config</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="n">p3</span> <span class="o">&lt;-</span> <span class="n">plot_snp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
    <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank_snp</span><span class="p">,</span>
    <span class="n">label_size</span> <span class="o">=</span> <span class="n">label_size_snp</span><span class="p">,</span> 
    <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">lim_prob_snp</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  
  <span class="n">plot_grid</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span>  <span class="n">labels</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">grid_nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">grid_ncol</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">plot_ncausal</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="n">ncausal</span>
  
  <span class="n">sum_prop_zero</span> <span class="o">&lt;-</span> <span class="nb">filter</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">ncausal_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[[</span><span class="s2">&quot;prob&quot;</span><span class="p">]]</span>  <span class="o">%&gt;%</span> <span class="nb">sum</span>
  <span class="k">if</span><span class="p">(</span><span class="n">sum_prop_zero</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="nb">filter</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">ncausal_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> 
    <span class="n">ncausal_num</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">ncausal_num</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">ncausal_num</span><span class="p">),</span> 
                                                    <span class="n">decreasing</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)),</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;prior&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">)))</span>
    
  <span class="n">p</span> <span class="o">&lt;-</span> <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">ncausal_num</span><span class="p">,</span> <span class="n">ncausal_prob</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="nb">type</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;dodge&quot;</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">coord_flip</span><span class="p">()</span> <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;grey50&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">))</span> <span class="o">+</span>
    <span class="n">ylim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span>
    
  <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">plot_set</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="nb">set</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">head</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">)</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> 
      <span class="s2">&quot;P = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">config_prob</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;log10(BF) = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">config_log10bf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">config_prob</span><span class="p">,</span> <span class="n">rank</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_point</span><span class="p">()</span> <span class="o">+</span> 
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xend</span> <span class="o">=</span> <span class="n">config_prob</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span> <span class="n">hjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nudge_x</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">label_size</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">xlim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span>  <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">top_rank</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">plot_snp</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="n">snp</span>
  
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">head</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">)</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">()),</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> 
      <span class="s2">&quot;P = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;log10(BF) = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_log10bf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="n">rank</span><span class="p">))</span> <span class="o">+</span>
    <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_point</span><span class="p">()</span> <span class="o">+</span> 
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xend</span> <span class="o">=</span> <span class="n">snp_prob</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span> <span class="n">hjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nudge_x</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">label_size</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">xlim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span>  <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">top_rank</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">png</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="n">plot_finemap</span><span class="p">(</span><span class="n">result</span><span class="p">[[</span><span class="n">r</span><span class="p">]],</span> <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank</span><span class="p">))</span>
<span class="p">}</span>
<span class="n">dev</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/plot_finemap.R" target="_blank">modules/plot_finemap.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="plot_caviar.R"><code>plot_caviar.R</code><a class="anchor-link" href="#plot_caviar.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">plot_caviar</span><span class="o">.</span><span class="n">R</span>
<span class="n">plot_caviar</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">grid_nrow</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span> 
                        <span class="n">grid_ncol</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span> 
                        <span class="n">label_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">top_rank</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                        <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">plot_snp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">plot_snp</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="n">snp</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">head</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">)</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> 
      <span class="s2">&quot;P = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;P(set) = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_prob_set</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="n">rank</span><span class="p">))</span> <span class="o">+</span>
    <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_point</span><span class="p">()</span> <span class="o">+</span> 
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xend</span> <span class="o">=</span> <span class="n">snp_prob</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span> <span class="n">hjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nudge_x</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">label_size</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">xlim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span>  <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">top_rank</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">png</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="n">plot_caviar</span><span class="p">(</span><span class="n">result</span><span class="p">[[</span><span class="n">r</span><span class="p">]],</span> <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank</span><span class="p">))</span>
<span class="p">}</span>
<span class="n">dev</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/plot_caviar.R" target="_blank">modules/plot_caviar.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="plot_dap.R"><code>plot_dap.R</code><a class="anchor-link" href="#plot_dap.R">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">plot_dap</span><span class="o">.</span><span class="n">R</span>


<span class="n">plot_dap</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                     <span class="n">grid_nrow</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                     <span class="n">grid_ncol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                     <span class="n">label_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="n">top_rank</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                     <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span>
                     <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">label_size_config</span> <span class="o">=</span> <span class="n">label_size</span>
  <span class="n">label_size_snp</span> <span class="o">=</span> <span class="n">label_size</span>
  <span class="n">top_rank_config</span> <span class="o">=</span> <span class="n">top_rank</span>
  <span class="n">top_rank_snp</span> <span class="o">=</span> <span class="n">top_rank</span>
  <span class="n">lim_prob_config</span> <span class="o">=</span> <span class="n">lim_prob</span>
  <span class="n">lim_prob_snp</span> <span class="o">=</span> <span class="n">lim_prob</span>
    
  <span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">plot_set</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  
    <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank_config</span><span class="p">,</span> 
    <span class="n">label_size</span> <span class="o">=</span> <span class="n">label_size_config</span><span class="p">,</span> 
    <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">lim_prob_config</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="n">p3</span> <span class="o">&lt;-</span> <span class="n">plot_snp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> 
    <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank_snp</span><span class="p">,</span>
    <span class="n">label_size</span> <span class="o">=</span> <span class="n">label_size_snp</span><span class="p">,</span> 
    <span class="n">lim_prob</span> <span class="o">=</span> <span class="n">lim_prob_snp</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  
  <span class="n">plot_grid</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span>  <span class="n">labels</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">grid_nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">grid_ncol</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">plot_set</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="nb">set</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">head</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">)</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> 
      <span class="s2">&quot;P = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">cluster_prob</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;avg(r^2) = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">cluster_avg_r2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">cluster_prob</span><span class="p">,</span> <span class="n">cluster</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_point</span><span class="p">()</span> <span class="o">+</span> 
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xend</span> <span class="o">=</span> <span class="n">cluster_prob</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span> <span class="n">hjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nudge_x</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">label_size</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">xlim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span>  <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">top_rank</span><span class="p">,</span> <span class="n">nrow</span><span class="p">(</span><span class="n">ptab</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">plot_snp</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lim_prob</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="err">$</span><span class="n">snp</span>
  
  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">head</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">top_rank</span><span class="p">)</span>

  <span class="n">ptab</span> <span class="o">&lt;-</span> <span class="n">mutate</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">()),</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">snp</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> 
      <span class="s2">&quot;P = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;log10(BF) = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">snp_log10bf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">ggplot</span><span class="p">(</span><span class="n">ptab</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">snp_prob</span><span class="p">,</span> <span class="n">rank</span><span class="p">))</span> <span class="o">+</span>
    <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">geom_point</span><span class="p">()</span> <span class="o">+</span> 
    <span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xend</span> <span class="o">=</span> <span class="n">snp_prob</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> 
    <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span> <span class="n">hjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nudge_x</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">label_size</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">xlim</span><span class="p">(</span><span class="n">lim_prob</span><span class="p">)</span> <span class="o">+</span> 
    <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span>  <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">top_rank</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">&quot;reverse&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">png</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="n">plot_dap</span><span class="p">(</span><span class="n">result</span><span class="p">[[</span><span class="n">r</span><span class="p">]],</span> <span class="n">top_rank</span> <span class="o">=</span> <span class="n">top_rank</span><span class="p">))</span>
<span class="p">}</span>
<span class="n">dev</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/plot_dap.R" target="_blank">modules/plot_dap.R</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="plot_sse.py"><code>plot_sse.py</code><a class="anchor-link" href="#plot_sse.py">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">plot_sse</span><span class="o">.</span><span class="n">py</span>

<span class="k">def</span> <span class="nf">plot_sse</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">true_coef</span><span class="p">,</span> <span class="n">in_set</span><span class="p">,</span> <span class="n">ld</span><span class="p">,</span> <span class="n">plot_prefix</span><span class="p">):</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">RegressionData</span><span class="p">()</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">set_xcorr</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">in_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">in_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">in_set</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">true_coef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">true_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_coef</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{plot_prefix}.{j+1}.png&#39;</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">plot_property_vector</span><span class="p">(</span><span class="n">coef</span><span class="p">[:,</span><span class="n">j</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">xz_cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">out</span> <span class="o">=</span> <span class="n">plot_file</span><span class="p">,</span>
                                 <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;Response {j+1}&#39;</span><span class="p">,</span> 
                                    <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;effect size estimate&#39;</span><span class="p">,</span> 
                                    <span class="s1">&#39;zlabel&#39;</span><span class="p">:</span> <span class="s1">&#39;In 95% CS&#39;</span><span class="p">})</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/plot_sse.py" target="_blank">modules/plot_sse.py</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="plot_susie.py"><code>plot_susie.py</code><a class="anchor-link" href="#plot_susie.py">&#182;</a></h3><ul>
<li>In addition to <code>plot_sse</code> which shows the single effects, here we summarize for each $l$ set:<ul>
<li>The size of 95% HPD interval</li>
<li>The purity of it (defined by the smallest pair-wise LD)</li>
<li>The minimum lfsr across conditions</li>
</ul>
</li>
</ul>
<p>we expect to see high correlation between small size, high purity and low lfsr.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">plot_susie</span><span class="o">.</span><span class="n">py</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#348ABD&#39;</span><span class="p">,</span> <span class="s1">&#39;#7A68A6&#39;</span><span class="p">,</span> <span class="s1">&#39;#A60628&#39;</span><span class="p">,</span> <span class="s1">&#39;#467821&#39;</span><span class="p">,</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#188487&#39;</span><span class="p">,</span> <span class="s1">&#39;#E2A233&#39;</span><span class="p">,</span>
              <span class="s1">&#39;#A9A9A9&#39;</span><span class="p">,</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span> <span class="s1">&#39;#ADFF2F&#39;</span><span class="p">,</span> <span class="s1">&#39;#00FFFF&#39;</span><span class="p">]</span>
<span class="n">color_mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">COLORS</span><span class="p">)])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">SusieReporter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cs</span><span class="p">,</span> <span class="n">lfsr</span><span class="p">,</span> <span class="n">true_coef</span><span class="p">,</span> <span class="n">ld_mat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonzeros</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">true_coef</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="n">ld_mat</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cs</span><span class="p">(</span><span class="n">in_cs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lfsr</span> <span class="o">=</span> <span class="n">lfsr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_captured</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonzeros</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signal_captured</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonzeros</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_in_cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">in_cs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">purity_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cs_purity</span><span class="p">()</span>

        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_set_positions</span><span class="p">(</span><span class="n">in_cs</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curr_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">in_cs</span><span class="p">):</span>
            <span class="n">lg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_len</span><span class="p">,</span> <span class="n">curr_len</span> <span class="o">+</span> <span class="n">lg</span><span class="p">))</span>
            <span class="n">curr_len</span> <span class="o">+=</span> <span class="n">lg</span>
        <span class="k">return</span> <span class="n">positions</span>

    <span class="k">def</span> <span class="nf">get_cs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_set_positions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">in_cs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_purity_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">purity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">purity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">purity</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">plot_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg_file</span><span class="p">,</span> <span class="n">ld_type</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">):</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">)])</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lengths</span><span class="p">)])</span>
        <span class="n">sets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">))</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">lengths</span><span class="p">,</span> <span class="n">sets</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonzeros</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#dcdcdc&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">):</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span>
            <span class="n">singletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{idx+1}: {int(self.n_in_cs[idx])} vars, {sum(self.signal_captured[idx])}/{len(self.signal_captured[idx])} hit, min(LD)={self.purity[:,self.purity_label[ld_type]][idx]:.2f}, lfsr={self.lfsr[idx]:.2f}&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">keep</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">keep</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">keep</span><span class="p">),</span> 
                       <span class="n">colors</span> <span class="o">=</span> <span class="n">color_mapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">keep</span><span class="p">)),</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;95% CS&quot;</span><span class="p">)</span>
    <span class="c1">#     plt.legend(loc=&#39;upper center&#39;, bbox_to_anchor=(0, -0.1),</span>
    <span class="c1">#                 mode=&quot;expand&quot;, borderaxespad=0, ncol=1)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">seg_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>                    
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">plot_purity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">purity_file</span><span class="p">,</span> <span class="n">ld_type</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span><span class="p">):</span>
        <span class="n">lds</span><span class="p">,</span> <span class="n">col_map</span> <span class="o">=</span> <span class="n">get_purity_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
        <span class="n">ld_idx</span> <span class="o">=</span> <span class="n">col_map</span><span class="p">[</span><span class="n">ld_type</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lds</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">L</span> <span class="o">//</span> <span class="n">cols</span> <span class="o">+</span> <span class="n">L</span> <span class="o">%</span> <span class="n">cols</span>
        <span class="n">position</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">ld</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">lds</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[:,</span><span class="n">ld_idx</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">position</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;L={idx}&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">color_mapper</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;95% CI set sizes vs {ld_type}(abs(LD))&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">purity_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>                    
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_cs_purity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">[</span><span class="n">idx</span><span class="p">,:][:,</span><span class="n">idx</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">lds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lds</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    
<span class="k">def</span> <span class="nf">plot_sets</span><span class="p">(</span><span class="n">in_cs</span><span class="p">,</span> <span class="n">lfsr</span><span class="p">,</span> <span class="n">true_coef</span><span class="p">,</span> <span class="n">ld_mat</span><span class="p">,</span> <span class="n">seg_prefix</span><span class="p">,</span> <span class="n">save_plot</span><span class="p">):</span>
    <span class="n">ld_status</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">signal_status</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_cs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">reporter</span> <span class="o">=</span> <span class="n">SusieReporter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">in_cs</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> 
                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lfsr</span><span class="p">)[:,</span> <span class="n">idx</span><span class="p">],</span> 
                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_coef</span><span class="p">)[:,</span> <span class="n">idx</span><span class="p">],</span> 
                                 <span class="n">ld_mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">plot_segments</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{seg_prefix}.{idx+1}.png&#39;</span><span class="p">)</span>
        <span class="n">ld_status</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">purity</span>
        <span class="n">signal_status</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">signal_captured</span>
    <span class="k">return</span> <span class="n">ld_status</span><span class="p">,</span> <span class="n">signal_status</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/plot_susie.py" target="_blank">modules/plot_susie.py</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simulation-under-regression-model">Simulation under regression model<a class="anchor-link" href="#Simulation-under-regression-model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="lib_regression_simulator.py"><code>lib_regression_simulator.py</code><a class="anchor-link" href="#lib_regression_simulator.py">&#182;</a></h3><ul>
<li><code>RegressionData</code>: Stores multivariate $Y$ and multiple feature $X$ data.</li>
<li><code>UnivariateMixture</code>: Simulating univariate effects with mixture distribution of effects: $\beta$ are sampled from normal mixtures as described in Stephens 2017 the ASH paper.</li>
<li><code>MultivariateMixture</code>: Multivariate mixture of Urbut 2017 the MASH paper.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">lib_regression_simulator</span><span class="o">.</span><span class="n">py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">class</span> <span class="nc">dotdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;dot.notation access to dictionary attributes&quot;&quot;&quot;</span>
    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dotdict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
    
<span class="k">class</span> <span class="nc">RegressionData</span><span class="p">(</span><span class="n">dotdict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># FIXME: check if inputs are indeed numpy arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">get_summary_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computer univariate regression for every X_j (N by 1) and Y_r (N by 1)</span>
<span class="sd">        Bhat: J by R matrix of estimated effects</span>
<span class="sd">        Shat: J by R matrix of SE of Bhat</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_covariates</span><span class="p">()</span>
        <span class="c1"># Compute betahat</span>
        <span class="n">XtX_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ji,ji-&gt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bhat</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">XtX_vec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># Compute se(betahat)</span>
        <span class="n">Xr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;jik&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,ijk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">Xr</span><span class="p">,</span> <span class="n">Xr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Shat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Re</span> <span class="o">/</span> <span class="n">XtX_vec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">remove_covariates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="err">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">center_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for np.array: np.mean(Z, axis=0, keepdims=True)</span>
        <span class="c1"># for np.matrix, no keepdims argument</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span>

    <span class="k">def</span> <span class="nf">set_xcorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xcorr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xcorr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xcorr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rowvar</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_xcorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">):</span>
        <span class="n">use_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please use png extension for output file.&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Plotting figure {out} for {limit} markers (default limit set to 5000) ...&#39;</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">light</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">limit</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">limit</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">use_abs</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">xticklabels</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">yticklabels</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Saving figure {out} ...&#39;</span><span class="p">)</span>        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">permute_X_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Permute X columns, i.e. break blocked correlation structure</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">plot_property_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">zaxis</span><span class="p">,</span> <span class="n">xz_cutoff</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;/tmp/1.png&#39;</span><span class="p">,</span>
                            <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;zlabel&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        - yaxis can be eg $\beta$ or log10BF or -log10Prob</span>
<span class="sd">        - zaxis can be some other quantity whose value will be </span>
<span class="sd">        reflected by color shade</span>
<span class="sd">        - xz_cutoff: (c1, c2). c1 is correlation cutoff to highlight</span>
<span class="sd">        when c2 is satisfied by a given position on x-axis</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yaxis</span><span class="p">))]</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">cubehelix_palette</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">rot</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">zaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;zlabel&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xz_cutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">zaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">xz_cutoff</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">zaxis</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">c2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Too many to highlight!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zaxis</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="n">c2</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xaxis</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">yaxis</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
                                   <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]):</span>
                            <span class="k">if</span> <span class="n">xx</span> <span class="o">&gt;</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xaxis</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">yaxis</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> 
                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;ylabel&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_representative_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_r2</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_indep_r2</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Based on xcorr matrix, select &quot;most representative features&quot;. </span>
<span class="sd">        That is, these features are potentially most convoluted by other features (have stronger xcorr)</span>
<span class="sd">        yet are independent among each other.</span>
<span class="sd">        - block_r2: definition of correlated block -- abs squared correlation have to be &gt; cutoff1</span>
<span class="sd">        - block_size: define a large enough block -- block size have to be &gt; block_size</span>
<span class="sd">        - max_indep_r2: now select features that are completely independent -- r2 &lt; max_indep_r2</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_xcorr</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># get r2 summary</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcorr</span><span class="p">)</span>
        <span class="n">strong_r2_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block_r2</span><span class="p">)</span> <span class="o">*</span> <span class="n">r2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">strong_r2_count</span> <span class="o">=</span> <span class="n">strong_r2_count</span><span class="p">[</span><span class="n">strong_r2_count</span> <span class="o">&gt;</span> <span class="n">block_size</span><span class="p">]</span>
        <span class="c1"># filter by r2</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strong_r2_count</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">strong_r2_count</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_indep_r2</span><span class="p">:</span>
                    <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strong_r2_count</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">ResidualVariance</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_identity</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Residual mode {self.mode} not implemented.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># multivariate case</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
    
<span class="k">class</span> <span class="nc">UnivariateMixture</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Simulated distributions of Stephens 2017 (ASH paper)&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">set_vanilla</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="n">amplitude</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">set_pi0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pi0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi0</span> <span class="o">=</span> <span class="n">pi0</span>
        
    <span class="k">def</span> <span class="nf">set_spiky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">set_near_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">set_flat_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-.</span><span class="mi">5</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span>
        
    <span class="k">def</span> <span class="nf">set_skew</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">set_big_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_bimodal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        beta ~ \pi_0\delta_0 + \sum \pi_i N(mu_i, sigma_i)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">))</span> <span class="o">==</span> <span class="n">sigmas</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">mix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mus</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mix</span> <span class="o">*</span> <span class="n">masks</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">swap_top_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set top effects to given indices</span>
<span class="sd">        One can specify index, or use the &quot;top_index&quot;</span>
<span class="sd">        generated by RegressionData.get_representative_features()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">given_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">given_index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">given_infex</span><span class="p">:</span>
            <span class="n">nb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nb</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">given_index</span><span class="p">:</span>
                <span class="n">nb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">sparsify_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_non_zero</span><span class="p">,</span> <span class="n">top_only</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        top_only: only keep top `num_non_zero` effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top_only</span><span class="p">:</span>
            <span class="n">big_beta_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)]</span>
            <span class="n">selected_index</span> <span class="o">=</span> <span class="n">big_beta_index</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">big_beta_index</span><span class="p">),</span> <span class="n">num_non_zero</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">num_non_zero</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
    <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regression_data</span><span class="p">,</span> <span class="n">pve</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pve</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need one of sigma or pve.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pve</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pve</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;PVE has to be between 0 and 1, not {pve}.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">x_mean</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">regression_data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">regression_data</span><span class="o">.</span><span class="n">x_mean</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">x_var</span> <span class="o">=</span> <span class="n">x_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_mean</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">genetic_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_var</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">))</span>
            <span class="n">pheno_var</span> <span class="o">=</span> <span class="n">genetic_var</span> <span class="o">/</span> <span class="n">pve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residual_variance</span> <span class="o">=</span> <span class="n">pheno_var</span> <span class="o">-</span> <span class="n">genetic_var</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">regression_data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_variance</span><span class="p">,</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># y.reshape(len(y), 1)</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{} N({}, {}^2)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">)])</span>
        <span class="k">return</span> <span class="s1">&#39;{:.3f} \delta_0 + {:.3f} [{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi0</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">MultivariateMixture</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;FIXME: ideally implement Urbut 2017 simulated covs&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Us</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mus</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_canonical</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_pi0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pi0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi0</span>
        
    <span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        
    <span class="k">def</span> <span class="nf">_init_canonical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        U is a dict of </span>
<span class="sd">        - &quot;identity&quot; for the identity (effects are independent among conditions);</span>
<span class="sd">        - &quot;singletons&quot; for the set of matrices with just one non-zero entry x_{jj} = 1 (j=1,...,R); (effect specific to condition j);</span>
<span class="sd">        - &quot;equal_effects&quot; for the matrix of all 1s (effects are equal among conditions);</span>
<span class="sd">        - &quot;simple_het&quot; for a set of matrices with 1s on the diagonal and all off-diagonal elements equal to pho; (effects are correlated among conditions).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pho</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;singleton_{i+1}&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="s1">&#39;equal_effects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pho</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;simple_het_{idx+1}&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))</span> <span class="o">*</span> <span class="n">item</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;simple_het_{idx+1}&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">set_shared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All weights are on equal effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;equal_effects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
    <span class="k">def</span> <span class="nf">set_low_het</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All weights are on small het effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;simple_het_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
    <span class="k">def</span> <span class="nf">set_indep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All weights are on identity effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">set_singleton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All weights evenly set to given index of singleton effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">index</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;singleton_{item}&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>        
        
    <span class="k">def</span> <span class="nf">apply_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">x</span><span class="o">*</span><span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Us</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sum</span><span class="p">([[(</span><span class="n">f</span><span class="s2">&quot;{p}_{i+1}&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)))]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span> <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">],</span> <span class="p">[])</span> <span class="o">+</span> \
                      <span class="p">[(</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="s1">&#39;null&#39;</span><span class="p">])])</span>
        <span class="n">nG</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nG</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;{k}_{g+1}&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">nG</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">get_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generate B under multivariate normal mixture</span>
<span class="sd">        beta ~ \pi_0\delta_0 + \sum \pi_i N(0, U_i)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">):</span>
            <span class="c1"># sample distribution</span>
            <span class="n">dist_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="kp">name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">dist_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mus</span><span class="p">[</span><span class="s1">&#39;zeros&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Us</span><span class="p">[</span><span class="kp">name</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">sparsify_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_non_zero</span><span class="p">,</span> <span class="n">top_only</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        top_only: only keep top `num_non_zero` effects</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">top_only</span><span class="p">:</span>
            <span class="n">beta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">big_beta_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">beta_max</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)]</span>
            <span class="n">selected_index</span> <span class="o">=</span> <span class="n">big_beta_index</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">big_beta_index</span><span class="p">),</span> <span class="n">num_non_zero</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">num_non_zero</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mus</span><span class="p">[</span><span class="s1">&#39;zeros&#39;</span><span class="p">]</span>
                
    <span class="k">def</span> <span class="nf">swap_top_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set top effects to given indices</span>
<span class="sd">        One can specify index, or use the &quot;top_index&quot;</span>
<span class="sd">        generated by RegressionData.get_representative_features()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">given_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">given_index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">beta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">big_beta_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">beta_max</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">given_index</span><span class="p">:</span>
            <span class="n">nb</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="n">big_beta_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),:]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">given_index</span><span class="p">:</span>
                <span class="n">nb</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="n">big_beta_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="n">nb</span>
        
    <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regression_data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_variance</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="k">return</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">X</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_variance</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/lib_regression_simulator.py" target="_blank">modules/lib_regression_simulator.py</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="regression_simulator.py"><code>regression_simulator.py</code><a class="anchor-link" href="#regression_simulator.py">&#182;</a></h3><p>Simulator workhorses.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">regression_simulator</span><span class="o">.</span><span class="n">py</span>
<span class="k">def</span> <span class="nf">summarize_LD</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ld_input</span><span class="p">,</span> <span class="n">ld_plot</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">RegressionData</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">data</span><span class="o">.</span><span class="n">set_xcorr</span><span class="p">(</span><span class="n">ld_input</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">plot_xcorr</span><span class="p">(</span><span class="n">ld_plot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get_representative_features</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">simulate_main</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">plot_prefix</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    data: $data</span>
<span class="sd">    top_idx: $top_eff</span>
<span class="sd">    n_signal: 3</span>
<span class="sd">    n_traits: 2</span>
<span class="sd">    eff_mode: mash_low_het</span>
<span class="sd">    swap_eff: True</span>
<span class="sd">    keep_ld: True</span>
<span class="sd">    tag: sim1</span>
<span class="sd">    @ALIAS: conf = Dict(!data, !eff_mode)</span>
<span class="sd">    $data: data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">RegressionData</span><span class="p">()</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eff_mode</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[</span><span class="s1">&#39;swap_eff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;swap_eff&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;top_idx&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&quot;top_idx&quot; variable is not set by an upstream module&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eff_mode</span> <span class="o">==</span> <span class="s1">&#39;mash_low_het&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;n_traits&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Cannot simulate {c[&quot;n_traits&quot;]} under mode {eff_mode}&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;residual_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mash_low_het</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eff_mode</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_y</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;residual_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">eff_mode</span> <span class="o">==</span> <span class="s1">&#39;simple_lm&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;residual_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_lm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Mode {eff_mode} is not implemented.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;center_data&#39;</span><span class="p">]:</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">center_data</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">X</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">Y</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allele_freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">x_mean</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">x_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allele_freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allele_freq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">plot_file</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{plot_prefix}.{j+1}.png&#39;</span>
            <span class="n">reg</span><span class="o">.</span><span class="n">plot_property_vector</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">][:,</span><span class="n">j</span><span class="p">],</span> 
                                 <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">][:,</span><span class="n">j</span><span class="p">]],</span> 
                                 <span class="n">xz_cutoff</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">plot_file</span><span class="p">,</span>
                                <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;Response {j+1}&#39;</span><span class="p">,</span> 
                                        <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;effect size&#39;</span><span class="p">,</span> <span class="s1">&#39;zlabel&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">rowvar</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
        
<span class="k">def</span> <span class="nf">original_y</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span> <span class="k">if</span> <span class="s1">&#39;true_coef&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;true_coef&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">simple_lm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">eff</span> <span class="o">=</span> <span class="n">UnivariateMixture</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">eff</span><span class="o">.</span><span class="n">set_vanilla</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">])</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;n_traits&#39;</span><span class="p">]):</span>
        <span class="n">eff</span><span class="o">.</span><span class="n">get_effects</span><span class="p">()</span>
        <span class="n">eff</span><span class="o">.</span><span class="n">sparsify_effects</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;n_signal&#39;</span><span class="p">])</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">pve</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;pve&#39;</span><span class="p">]))</span>
        <span class="n">coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff</span><span class="o">.</span><span class="n">coef</span><span class="p">)</span>
        <span class="n">sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff</span><span class="o">.</span><span class="n">residual_variance</span><span class="p">)</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">mash_low_het</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;keep_ld&#39;</span><span class="p">]:</span>
        <span class="n">reg</span><span class="o">.</span><span class="n">permuate_X_columns</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">X</span>
    <span class="n">eff</span> <span class="o">=</span> <span class="n">MultivariateMixture</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;n_traits&#39;</span><span class="p">]))</span>
    <span class="n">eff</span><span class="o">.</span><span class="n">set_low_het</span><span class="p">()</span>
    <span class="n">eff</span><span class="o">.</span><span class="n">apply_grid</span><span class="p">()</span>
    <span class="n">eff</span><span class="o">.</span><span class="n">get_effects</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;swap_eff&#39;</span><span class="p">]:</span>
        <span class="n">eff</span><span class="o">.</span><span class="n">swap_top_effects</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;top_idx&#39;</span><span class="p">])</span>
    <span class="n">eff</span><span class="o">.</span><span class="n">sparsify_effects</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;n_signal&#39;</span><span class="p">])</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">eff</span><span class="o">.</span><span class="n">get_y</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ResidualVariance</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;residual_mode&#39;</span><span class="p">],</span> <span class="n">eff</span><span class="o">.</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">eff</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">eff</span><span class="o">.</span><span class="n">residual_variance</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/regression_simulator.py" target="_blank">modules/regression_simulator.py</a></div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="dap_g_paper.R"><code>dap_g_paper.R</code><a class="anchor-link" href="#dap_g_paper.R">&#182;</a></h3><p>Simulation from DAP-g paper, code on <a href="https://github.com/xqwen/dap/tree/master/dap-g_paper/simulation/data_generation">dap-g github</a>.</p>
<blockquote><p>We set up a simulation scenario mimickingcis-eQTL mapping in a practical setting. In particular, we use the real genotype data from 343 European individuals from the GUEVADIS project. We artificially construct a genomic region of 1,001 SNPs. The region is divided into 91 LD blocks, and each block contains 11 SNPs. All LD blocks are selected from chromosome 1, and the consecutive blocks are at least 1Mb apart. With this construction scheme, the LD only presents within each block, and the SNP genotypes are mostly uncorrelated across blocks</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">save</span> <span class="o">-</span><span class="n">f</span> <span class="n">modules</span><span class="o">/</span><span class="n">dap_g_paper</span><span class="o">.</span><span class="n">R</span>
<span class="c1">## args = commandArgs(trailingOnly=TRUE)</span>
<span class="c1">## index = args[1]</span>
<span class="c1">## X = as.matrix(read.table(&quot;sim.r.geno&quot;))</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">dim</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>      <span class="c1"># number of observations</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">dim</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>      <span class="c1"># number of variables</span>
<span class="n">freq</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="n">region</span> <span class="o">=</span> <span class="n">rbinom</span><span class="p">(</span><span class="mi">91</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">freq</span><span class="p">)</span>
<span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.6</span>

<span class="n">get</span><span class="o">.</span><span class="n">beta</span><span class="o">&lt;-</span><span class="n">function</span><span class="p">(</span><span class="n">v</span><span class="p">){</span>
  <span class="n">rstv</span> <span class="o">=</span> <span class="n">rep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rstv</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="n">rnorm</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sd</span><span class="o">=</span><span class="n">amplitude</span><span class="p">);</span>

  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">rstv</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">beta</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">get</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span>

<span class="n">y</span><span class="o">.</span><span class="n">sample</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">()</span> <span class="n">X</span> <span class="o">%*%</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">Cell content saved to <a href="modules/dap_g_paper.R" target="_blank">modules/dap_g_paper.R</a></div>
</div>

</div>

</div>
</div>

</div>
<hr>
Copyright &copy 2016-2018 Gao Wang et al at Stephens Lab, University of Chicago
<p><small>Exported from <a href="http://github.com/gaow/mvarbvs/blob/d9c9a7a0baee05e827c5fc410cc9921251c16c93/dsc/finemapping.ipynb"><code>dsc/finemapping.ipynb</code></a> committed by Gao Wang on Wed Jun 6 13:12:56 2018 <a href="http://github.com/gaow/mvarbvs/commit/d9c9a7a0baee05e827c5fc410cc9921251c16c93">revision 32, d9c9a7a</a> <a href="https://stephenslab.github.io/ipynb-website/notes.html#Note-about-commit-ids"><span class="fa fa-question-circle"></span></a></small></p>
</div>
</div>
</body>
</html>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="ipynb_website:version" content="0.9.7" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" type="text/css" href="../css/jt.css">

<link rel="stylesheet" type="text/css" href="../css/toc2.css">

<link href="../site_libs/jqueryui-1.11.4/jquery-ui.css">
<link rel="stylesheet" href="../site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>

<link rel="stylesheet"
      href="../site_libs/highlightjs/null.min.css"
      type="text/css" />

<script src="../site_libs/highlightjs/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>

<script src="../js/doc_toc.js"></script>
<script src="../js/docs.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
        },
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>
<script>
function filterDataFrame(id) {
    var input = document.getElementById("search_" + id);
    var filter = input.value.toUpperCase();
    var table = document.getElementById("dataframe_" + id);
    var tr = table.getElementsByTagName("tr");
    // Loop through all table rows, and hide those who don't match the search query
    for (var i = 1; i < tr.length; i++) {
        for (var j = 0; j < tr[i].cells.length; ++j) {
            var matched = false;
            if (tr[i].cells[j].innerHTML.toUpperCase().indexOf(filter) != -1) {
                tr[i].style.display = "";
                matched = true
                break;
            }
            if (!matched)
                tr[i].style.display = "none";
        }
    }
}
function sortDataFrame(id, n, dtype) {
    var table = document.getElementById("dataframe_" + id);
    var tb = table.tBodies[0]; // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
    var tr = Array.prototype.slice.call(tb.rows, 0); // put rows into array
    if (dtype === 'numeric') {
        var fn = function(a, b) { 
            return parseFloat(a.cells[n].textContent) <= parseFloat(b.cells[n].textContent) ? -1 : 1;
        }
    } else {
        var fn = function(a, b) {
            var c = a.cells[n].textContent.trim().localeCompare(b.cells[n].textContent.trim()); 
            return c > 0 ? 1 : (c < 0 ? -1 : 0) }
    }
    var isSorted = function(array, fn) {
        if (array.length < 2)
            return 1;
        var direction = fn(array[0], array[1]); 
        for (var i = 1; i < array.length - 1; ++i) {
            var d = fn(array[i], array[i+1]);
            if (d == 0)
                continue;
            else if (direction == 0)
                direction = d;
            else if (direction != d)
                return 0;
            }
        return direction;
    }
    var sorted = isSorted(tr, fn);
    if (sorted == 1 || sorted == -1) {
        // if sorted already, reverse it
        for(var i = tr.length - 1; i >= 0; --i)
            tb.appendChild(tr[i]); // append each row in order
    } else {
        tr = tr.sort(fn);
        for(var i = 0; i < tr.length; ++i)
            tb.appendChild(tr[i]); // append each row in order
    }
}
</script>

<script>
$( document ).ready(function(){
            var cfg={'threshold':3,     // depth of toc (number of levels)
             'number_sections': false,
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }
            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;
            // fire the main function with these parameters
            table_of_contents(cfg, st);
            var file=analysisDict[$("h1:first").attr("id")];
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=analysisArray;
            var docs_map=analysisArrayMap;
            var pos=analysisArray.indexOf(file);
            for (var a=pos;a>=0;a--){
                  $('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+file+'.html'+'"]').css("color","#126dce");
            for (var a=pos+1;a<docs.length;a++){
                  $(".toc #toc-level0").append('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>');
            }
            // $("#toc-header").hide(); // comment out because it prevents search bar from displaying
    });
</script>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');
  // mark it active
  menuAnchor.parent().addClass('active');
  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>
<div class="container-fluid main-container">
<!-- tabsets -->
<script src="../site_libs/navigation-1.1/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>



<title>Multivariate Bayesian variable selection regression</title>

<style type = "text/css">
body {
  font-family: "Droid Sans";
  padding-top: 66px;
  padding-bottom: 40px;
}
</style>
</head>

<body>
<div tabindex="-1" id="notebook" class="border-box-sizing">
<div class="container" id="notebook-container">

<!-- code folding -->

<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Multivariate Bayesian variable selection regression</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
<li>
  <a href="../index.html">Overview</a>
</li>
        
<li>
  <a href="../analysis.html">Analysis</a>
</li>
        
<li>
  <a href="../prototype.html">Prototype</a>
</li>
        
<li>
  <a href="../writeup.html">Writeup</a>
</li>
        
      </ul>
        
<ul class="nav navbar-nav navbar-right">
<li>
   <a href="http://github.com/gaow/mvarbvs"> <span class="fa fa-github"></span> </a>
</li>
</ul>
        
      </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Preparing-input-data-for-MASH-analysis">Preparing input data for MASH analysis<a class="anchor-link" href="#Preparing-input-data-for-MASH-analysis">&#182;</a></h1><p>This include input max Z score from univariate analysis and training data, for both before and after LD pruning.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is in part responding the reviewer's request that we should use independent subset of SNPs to fit mash model and analyze, and compare with results ignoring the LD (as done in Urbut 2017).</p>
<h2 id="Obtain-data">Obtain data<a class="anchor-link" href="#Obtain-data">&#182;</a></h2><p>The required data has <a href="https://github.com/stephenslab/gtex-eqtls/blob/v6-archive/archive/src/python/analysis_admin.py#L318">previously been extracted</a> from GTEx V6 stored in midway:</p>

<pre><code>/project/mstephens/data/internal_supp/gtex-v6-sumstat-hdf5/MatrixEQTLSumStats.Portable.h5</code></pre>
<p>It's a 58MB file containing only <code>max</code> and <code>null</code> summary statistics. For convenience I copy it to my local computer and process from there (see cell below).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="s1">&#39;~/Documents/GTEx/mash_revision&#39;</span>
<span class="n">input_db</span> <span class="o">=</span> <span class="s2">&quot;${cwd!a}/MatrixEQTLSumStats.Portable.h5&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">sosrun</span> <span class="n">get_input</span>
<span class="p">[</span><span class="n">get_input</span><span class="p">:</span> <span class="kp">provides</span> <span class="o">=</span> <span class="n">input_db</span><span class="p">]</span>
<span class="kn">output:</span> <span class="n">input_db</span>
<span class="kn">task:</span>
<span class="kn">run:</span>
    <span class="n">rsync</span> <span class="o">-</span><span class="n">auzP</span> <span class="n">mw</span><span class="p">:</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">mstephens</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">internal_supp</span><span class="o">/</span><span class="n">gtex</span><span class="o">-</span><span class="n">v6</span><span class="o">-</span><span class="n">sumstat</span><span class="o">-</span><span class="n">hdf5</span><span class="o">/</span><span class="n">MatrixEQTLSumStats</span><span class="o">.</span><span class="n">Portable</span><span class="o">.</span><span class="n">h5</span> <span class="err">$</span><span class="p">{</span><span class="n">input_db</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div class="sos_hint">1 task completed: <a onclick="task_info('caf98d1091c1a4cf891b9e67d5d2f215', 'localhost')">caf9</a></div>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extract-training-and-testing-data">Extract training and testing data<a class="anchor-link" href="#Extract-training-and-testing-data">&#182;</a></h2><p>The cell below loads the data, compute z-score, get a training set (and its correlation estimate $\hat{V}$) and save to an RDS file for use with <code>mash</code> analysis. Parameter <code>exclude_list</code> specifies path to the file of rownames to exclude while extracting: by default it uses all SNPs but if a list is provided (eg list after LD pruning) it will only extract results for those SNPs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">sosrun</span> <span class="n">extract_zscore</span>
<span class="p">[</span><span class="n">extract_zscore</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">exclude_list</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
<span class="kn">parameter:</span> <span class="n">num_train</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;rhdf5&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">input_db</span>
<span class="kn">output:</span> <span class="s2">&quot;${input_db!n}.Z.rds&quot;</span> <span class="k">if</span> <span class="n">exclude_list</span> <span class="o">==</span> <span class="s1">&#39;NULL&#39;</span> <span class="k">else</span> <span class="s2">&quot;${input_db!n}.${exclude_list!bn}.Z.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span>
<span class="kn">R:</span>
    <span class="n">ConvertP2Z</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">pval</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">z</span> <span class="o">&lt;-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qnorm</span><span class="p">(</span><span class="n">pval</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
      <span class="n">z</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">beta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">beta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span>
      <span class="k">return</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">GetSS</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dat</span> <span class="o">&lt;-</span> <span class="n">rhdf5</span><span class="p">::</span><span class="n">h5read</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">gene</span><span class="p">)</span>
      <span class="n">dat</span><span class="err">$</span><span class="s2">&quot;z-score&quot;</span> <span class="o">&lt;-</span> <span class="n">ConvertP2Z</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="n">dat</span><span class="err">$</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kp">name</span> <span class="ow">in</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;t-stat&quot;</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="s2">&quot;z-score&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">t</span><span class="p">(</span><span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]])</span>
        <span class="n">colnames</span><span class="p">(</span><span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]])</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="err">$</span><span class="n">colnames</span>
        <span class="n">rownames</span><span class="p">(</span><span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]])</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="err">$</span><span class="n">rownames</span>
      <span class="p">}</span>
      <span class="n">dat</span><span class="err">$</span><span class="n">colnames</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="err">$</span><span class="n">rownames</span> <span class="o">&lt;-</span> <span class="n">NULL</span>
      <span class="k">return</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">load_data</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># load data</span>
        <span class="n">mdat</span> <span class="o">=</span> <span class="n">GetSS</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="err">!</span><span class="n">r</span><span class="p">})[[</span><span class="n">table</span><span class="p">]]</span>
        <span class="n">ndat</span> <span class="o">=</span> <span class="n">GetSS</span><span class="p">(</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="nb">input</span><span class="err">!</span><span class="n">r</span><span class="p">})[[</span><span class="n">table</span><span class="p">]]</span>
        <span class="c1"># select rows to keep</span>
        <span class="n">num_train</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">num_train</span><span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_train</span> <span class="o">&gt;=</span> <span class="n">nrow</span><span class="p">(</span><span class="n">ndat</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">num_train</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">ndat</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">ndat</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">num_train</span><span class="p">,]</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="n">ndat</span><span class="p">[(</span><span class="n">num_train</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">nrow</span><span class="p">(</span><span class="n">ndat</span><span class="p">),]</span>
        <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">exclude_list</span><span class="err">!</span><span class="n">r</span><span class="p">}</span> <span class="o">!=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pout</span> <span class="o">=</span> <span class="n">scan</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">exclude_list</span><span class="err">!</span><span class="n">r</span><span class="p">},</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">NULL</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">mdat</span><span class="p">),</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="sb">`[`</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="n">mdat</span> <span class="o">=</span> <span class="n">mdat</span><span class="p">[</span><span class="err">!</span><span class="p">(</span><span class="n">names</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">pout</span><span class="p">),]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">ndat</span><span class="p">),</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="sb">`[`</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="n">ndat</span> <span class="o">=</span> <span class="n">ndat</span><span class="p">[</span><span class="err">!</span><span class="p">(</span><span class="n">names</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">pout</span><span class="p">),]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="sb">`[`</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="err">!</span><span class="p">(</span><span class="n">names</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">pout</span><span class="p">),]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">validate</span><span class="p">),</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="sb">`[`</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="n">validate</span><span class="p">[</span><span class="err">!</span><span class="p">(</span><span class="n">names</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">pout</span><span class="p">),]</span>                                              
        <span class="p">}</span>
        <span class="c1"># get vhat (SVS)</span>
        <span class="n">vhat</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;z-score&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_absz</span> <span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ndat</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
            <span class="n">nullish</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">max_absz</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nz</span> <span class="o">=</span> <span class="n">ndat</span><span class="p">[</span><span class="n">nullish</span><span class="p">,]</span>
            <span class="n">vhat</span> <span class="o">=</span> <span class="n">cor</span><span class="p">(</span><span class="n">nz</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">,</span>
               <span class="n">validate</span> <span class="o">=</span> <span class="n">validate</span><span class="p">,</span> 
               <span class="n">test</span> <span class="o">=</span> <span class="n">mdat</span><span class="p">,</span> <span class="n">vhat</span> <span class="o">=</span> <span class="n">vhat</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="n">ztable</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s2">&quot;z-score&quot;</span><span class="p">)</span>
    <span class="n">btable</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
    <span class="c1"># save output</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ztable</span><span class="err">$</span><span class="n">train</span><span class="p">,</span>
                 <span class="n">validate</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ztable</span><span class="err">$</span><span class="n">validate</span><span class="p">,</span>
                 <span class="n">test</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ztable</span><span class="err">$</span><span class="n">test</span><span class="p">,</span>
                 <span class="n">train</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">btable</span><span class="err">$</span><span class="n">train</span><span class="p">,</span>
                 <span class="n">validate</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">btable</span><span class="err">$</span><span class="n">validate</span><span class="p">,</span>
                 <span class="n">test</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">btable</span><span class="err">$</span><span class="n">test</span><span class="p">,</span>
                 <span class="n">vhat</span> <span class="o">=</span> <span class="n">ztable</span><span class="err">$</span><span class="n">vhat</span><span class="p">),</span> <span class="err">$</span><span class="p">{</span><span class="n">output</span><span class="err">!</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">R:</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">&quot;${input_db!n}.Z.rds&quot;</span><span class="p">)</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>List of 7
 $ train.z   : num [1:20000, 1:44] -0.184 0.161 -1.291 -1.628 0.778 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:20000] &#34;ENSG00000000419.8_20_49782767_C_G_b37&#34; &#34;ENSG00000000419.8_20_49654572_A_G_b37&#34; &#34;ENSG00000000419.8_20_49392478_A_G_b37&#34; &#34;ENSG00000000457.9_1_169117725_TG_T_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ validate.z: num [1:28198, 1:44] 0.107 1.1672 0.2172 0.3499 -0.0481 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:28198] &#34;ENSG00000151665.8_2_47601407_A_G_b37&#34; &#34;ENSG00000151687.10_2_190118691_T_G_b37&#34; &#34;ENSG00000151687.10_2_191462133_C_T_b37&#34; &#34;ENSG00000151687.10_2_190620957_G_A_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ test.z    : num [1:16069, 1:44] 0.14 0.955 0.32 1.844 -4.235 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:16069(1d)] &#34;ENSG00000000419.8_20_49461813_G_C_b37&#34; &#34;ENSG00000000457.9_1_169695110_T_A_b37&#34; &#34;ENSG00000000460.12_1_169655079_G_A_b37&#34; &#34;ENSG00000000938.8_1_27888990_T_C_b37&#34; ...
  .. ..$ : chr [1:44(1d)] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ train.b   : num [1:20000, 1:44] -0.01192 0.00986 -0.11973 -0.09686 0.05309 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:20000] &#34;ENSG00000000419.8_20_49782767_C_G_b37&#34; &#34;ENSG00000000419.8_20_49654572_A_G_b37&#34; &#34;ENSG00000000419.8_20_49392478_A_G_b37&#34; &#34;ENSG00000000457.9_1_169117725_TG_T_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ validate.b: num [1:28198, 1:44] 0.00967 0.08876 0.0131 0.02502 -0.00229 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:28198] &#34;ENSG00000151665.8_2_47601407_A_G_b37&#34; &#34;ENSG00000151687.10_2_190118691_T_G_b37&#34; &#34;ENSG00000151687.10_2_191462133_C_T_b37&#34; &#34;ENSG00000151687.10_2_190620957_G_A_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ test.b    : num [1:16069, 1:44] 0.0105 0.1067 0.0168 0.0853 -0.2458 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:16069(1d)] &#34;ENSG00000000419.8_20_49461813_G_C_b37&#34; &#34;ENSG00000000457.9_1_169695110_T_A_b37&#34; &#34;ENSG00000000460.12_1_169655079_G_A_b37&#34; &#34;ENSG00000000938.8_1_27888990_T_C_b37&#34; ...
  .. ..$ : chr [1:44(1d)] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ vhat      : num [1:44, 1:44] 1 0.0674 0.0142 0.0686 0.03 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Extract-from-selected-list">Extract from selected list<a class="anchor-link" href="#Extract-from-selected-list">&#182;</a></h1><p>The default procedure above extracts all SNPs to RDS. Here running previously established workflows we create lists of LD pruned SNPs. To prune SNPs based on what we have in the database and the actual genotypes, first we extract SNP names the database (done previously) and feed them to LD pruning routine.</p>
<p>For test SNPs</p>
<div class="highlight"><pre><span></span>sos run analysis/20170828_Compute_LD.ipynb get_ld:1-2 -b ~/Documents/GTEx/bin <span class="se">\</span>
    --input_list <span class="nv">$HOME</span>/Documents/GTEx/mash_revision/snp_eqtl.txt
</pre></div>

<pre><code>Pruning complete.  4204 of 13030 variants removed.</code></pre>
<p>For train SNPs</p>
<div class="highlight"><pre><span></span>sos run analysis/20170828_Compute_LD.ipynb get_ld:1-2 -b ~/Documents/GTEx/bin <span class="se">\</span>
    --input_list <span class="nv">$HOME</span>/Documents/GTEx/mash_revision/snp_random.txt
</pre></div>

<pre><code>Pruning complete.  19405 of 41038 variants removed.</code></pre>
<p>We end up with two lists: <code>snp_eqtls.extracted.prune.out</code> and <code>snp_random.extracted.prune.out</code>. We consolidate them to one list <code>ld2.out</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="err">!</span><span class="n">cat</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">gaow</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">GTEx</span><span class="o">/</span><span class="n">mash_revision</span><span class="o">/</span><span class="n">snp_eqtls</span><span class="o">.</span><span class="n">extracted</span><span class="o">.</span><span class="n">prune</span><span class="o">.</span><span class="n">out</span> \
     <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">gaow</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">GTEx</span><span class="o">/</span><span class="n">mash_revision</span><span class="o">/</span><span class="n">snp_random</span><span class="o">.</span><span class="n">extracted</span><span class="o">.</span><span class="n">prune</span><span class="o">.</span><span class="n">out</span> <span class="o">&gt;</span> \
     <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">gaow</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">GTEx</span><span class="o">/</span><span class="n">mash_revision</span><span class="o">/</span><span class="n">ld2</span><span class="o">.</span><span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To extract data excluding <code>ld2.out</code> simply execute the workflow above with <code>exclude_list</code> set to <code>ld2.out</code>:</p>

<pre><code>sos run analysis/20170829_MASH_Input_Preparation extract_zscore \
    --exclude_list /home/gaow/Documents/GTEx/mash_revision/ld2.out</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">R:</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">&quot;${input_db!n}.ld2.Z.rds&quot;</span><span class="p">)</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>List of 7
 $ train.z   : num [1:12143, 1:44] -0.184 0.161 -1.291 -1.628 0.778 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:12143] &#34;ENSG00000000419.8_20_49782767_C_G_b37&#34; &#34;ENSG00000000419.8_20_49654572_A_G_b37&#34; &#34;ENSG00000000419.8_20_49392478_A_G_b37&#34; &#34;ENSG00000000457.9_1_169117725_TG_T_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ validate.z: num [1:16316, 1:44] 1.167 1.099 3.371 0.293 -0.384 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:16316] &#34;ENSG00000151687.10_2_190118691_T_G_b37&#34; &#34;ENSG00000151689.8_2_191969341_C_T_b37&#34; &#34;ENSG00000151690.10_2_191471847_C_T_b37&#34; &#34;ENSG00000151690.10_2_191018883_G_A_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ test.z    : num [1:11619, 1:44] 0.14 0.955 0.32 -4.235 -3.829 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:11619] &#34;ENSG00000000419.8_20_49461813_G_C_b37&#34; &#34;ENSG00000000457.9_1_169695110_T_A_b37&#34; &#34;ENSG00000000460.12_1_169655079_G_A_b37&#34; &#34;ENSG00000000971.11_1_196513323_A_G_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ train.b   : num [1:12143, 1:44] -0.01192 0.00986 -0.11973 -0.09686 0.05309 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:12143] &#34;ENSG00000000419.8_20_49782767_C_G_b37&#34; &#34;ENSG00000000419.8_20_49654572_A_G_b37&#34; &#34;ENSG00000000419.8_20_49392478_A_G_b37&#34; &#34;ENSG00000000457.9_1_169117725_TG_T_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ validate.b: num [1:16316, 1:44] 0.0888 0.064 0.1382 0.0142 -0.0199 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:16316] &#34;ENSG00000151687.10_2_190118691_T_G_b37&#34; &#34;ENSG00000151689.8_2_191969341_C_T_b37&#34; &#34;ENSG00000151690.10_2_191471847_C_T_b37&#34; &#34;ENSG00000151690.10_2_191018883_G_A_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ test.b    : num [1:11619, 1:44] 0.0105 0.1067 0.0168 -0.2458 -0.1605 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:11619] &#34;ENSG00000000419.8_20_49461813_G_C_b37&#34; &#34;ENSG00000000457.9_1_169695110_T_A_b37&#34; &#34;ENSG00000000460.12_1_169655079_G_A_b37&#34; &#34;ENSG00000000971.11_1_196513323_A_G_b37&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
 $ vhat      : num [1:44, 1:44] 1 0.0924 0.0127 0.0792 0.0415 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
  .. ..$ : chr [1:44] &#34;Adipose_Subcutaneous&#34; &#34;Adipose_Visceral_Omentum&#34; &#34;Adrenal_Gland&#34; &#34;Artery_Aorta&#34; ...
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a result of pruning the training set dropped from 20K to 12K, the test set dropped from 16K to 11.6K.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">sessioninfo</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<p class="session_section">SoS</p>
<table class="session_info">
<tr>
<th>SoS Version</th><td><pre>0.9.8.10</pre></td>
</tr>
</table>
<p class="session_section">R</p>
<table class="session_info">
<tr>
<th>Kernel</th><td><pre>ir</pre></td>
</tr>
<tr>
<th>Language</th><td><pre>R</pre></td>
</tr>
<tr>
<td colspan="2"><pre>R version 3.4.0 (2017-04-21)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: BunsenLabs GNU/Linux 8.7 (Hydrogen)

Matrix products: default
BLAS: /usr/lib64/microsoft-r/3.4/lib64/R/lib/libRblas.so
LAPACK: /usr/lib64/microsoft-r/3.4/lib64/R/lib/libRlapack.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] RevoUtilsMath_10.0.0

loaded via a namespace (and not attached):
 [1] compiler_3.4.0      R6_2.2.0            magrittr_1.5       
 [4] RevoUtils_10.0.4    IRdisplay_0.4.4     pbdZMQ_0.2-5       
 [7] tools_3.4.0         crayon_1.3.2        uuid_0.1-2         
[10] stringi_1.1.5       IRkernel_0.8.7.9000 jsonlite_1.4       
[13] stringr_1.2.0       digest_0.6.12       repr_0.12.0        
[16] evaluate_0.10      </pre></td>
</tr>
</table>

</div>

</div>

</div>
</div>

</div>
<hr>
Copyright &copy 2016-2020 Gao Wang et al at Stephens Lab, University of Chicago

</div>
</div>
</body>
</html>
